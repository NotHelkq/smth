local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local TextService = game:GetService("TextService")

local DefaultTweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut)

local Themes = {
    Background = Color3.fromRGB(20, 20, 20),
    DarkBackground = Color3.fromRGB(15, 15, 15),
    LightContrast = Color3.fromRGB(35, 35, 35),
    DarkContrast = Color3.fromRGB(25, 25, 25),
    Selected = Color3.fromRGB(40, 40, 40),
    TextColor = Color3.fromRGB(220, 220, 220),
    Accent = Color3.fromRGB(255, 100, 50),
    CloseButton = Color3.fromRGB(255, 60, 60),
    MinimizeButton = Color3.fromRGB(255, 180, 40),
    BorderColor = Color3.fromRGB(50, 50, 50)
}

local DefaultUISize = UDim2.new(0, 800, 0, 500)

local Utility = {}

function Utility:Create(className, properties, children)
    local instance = Instance.new(className)
    for property, value in pairs(properties or {}) do
        instance[property] = value
        if typeof(value) == "Color3" then
            local themeKey = self:FindKey(Themes, value)
            if themeKey then
            end
        end
    end
    for _, child in pairs(children or {}) do
        child.Parent = instance
    end
    return instance
end

function Utility:Tween(instance, properties, duration, ...)
    local tweenInfo = TweenInfo.new(duration, ...)
    TweenService:Create(instance, tweenInfo, properties):Play()
end

function Utility:WaitForRenderStep()
    RunService.RenderStepped:Wait()
    return true
end

function Utility:FindKey(tbl, value)
    for key, val in pairs(tbl) do
        if val == value then
            return key
        end
    end
    return nil
end

function Utility:FilterList(pattern, list)
    pattern = pattern:lower()
    if pattern == "" then
        return list
    end
    local filtered = {}
    for _, item in pairs(list) do
        if tostring(item):lower():find(pattern) then
            table.insert(filtered, item)
        end
    end
    return filtered
end

function Utility:PopEffect(object, shrinkAmount)
    local clone = object:Clone()
    clone.AnchorPoint = Vector2.new(0.5, 0.5)
    clone.Size = clone.Size - UDim2.new(0, shrinkAmount, 0, shrinkAmount)
    clone.Position = UDim2.new(0.5, 0, 0.5, 0)
    clone.Parent = object
    clone:ClearAllChildren()
    object.ImageTransparency = 1
    self:Tween(clone, {Size = object.Size}, 0.2)
    task.delay(0.2, function()
        object.ImageTransparency = 0
        clone:Destroy()
    end)
    return clone
end

function Utility:InitKeybinds()
    local keybinds = {}
    local endedCallbacks = {}
    UserInputService.InputBegan:Connect(function(input, processed)
        if not processed and keybinds[input.KeyCode] then
            for _, callback in pairs(keybinds[input.KeyCode]) do
                callback()
            end
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            for _, callback in pairs(endedCallbacks) do
                callback()
            end
        end
    end)
    return {Keybinds = keybinds, EndedCallbacks = endedCallbacks}
end

function Utility:BindKey(keybindsTable, key, callback)
    keybindsTable[key] = keybindsTable[key] or {}
    local safeCallback = function()
        local success, err = pcall(callback)
        if not success then
            warn("Keybind callback error: " .. tostring(err))
        end
    end
    table.insert(keybindsTable[key], safeCallback)
    return {
        Unbind = function()
            for i, bind in pairs(keybindsTable[key]) do
                if bind == safeCallback then
                    table.remove(keybindsTable[key], i)
                    break
                end
            end
        end
    }
end

function Utility:WaitForKeyPress()
    local input = UserInputService.InputBegan:Wait()
    while input.UserInputType ~= Enum.UserInputType.Keyboard do
        input = UserInputService.InputBegan:Wait()
    end
    task.wait()
    return input
end

function Utility:EnableDragging(frame, target)
    target = target or frame
    local dragging = false
    local dragInput, mousePos, framePos
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            mousePos = input.Position
            framePos = target.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - mousePos
            target.Position = UDim2.new(framePos.X.Scale, framePos.X.Offset + delta.X, framePos.Y.Scale, framePos.Y.Offset + delta.Y)
        end
    end)
end

function Utility:OnDragEnd(endedCallbacks, callback)
    table.insert(endedCallbacks, callback)
end

function Utility:RecalculateLayout(instance)
    local layout = instance:FindFirstChildOfClass("UIListLayout") or instance:FindFirstChildOfClass("UIGridLayout")
    if layout then
        layout:ApplyLayout()
    end
    RunService.Heartbeat:Wait()
    RunService.Heartbeat:Wait()
end

local Library = {}
Library.__index = Library

function Library.New(title)
    local keybindSystem = Utility:InitKeybinds()
    local container = Utility:Create("ScreenGui", {
        Name = title or "Z3XHub",
        Parent = game.CoreGui,
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Global
    })
    
    -- Main Window with new design
    local mainFrame = Utility:Create("Frame", {
        Name = "MainFrame",
        Position = UDim2.new(0.5, -400, 0.5, -250),
        Size = DefaultUISize,
        BackgroundColor3 = Themes.Background,
        BorderSizePixel = 0
    }, {
        Utility:Create("UICorner", {CornerRadius = UDim.new(0, 8)}),
        Utility:Create("UIStroke", {
            Color = Themes.BorderColor,
            Thickness = 1,
            Transparency = 0.5
        }),
        
        -- Top Bar Area
        Utility:Create("Frame", {
            Name = "TopBar",
            Size = UDim2.new(1, 0, 0, 90),
            BackgroundColor3 = Themes.DarkBackground,
            BorderSizePixel = 0
        }, {
            Utility:Create("UICorner", {
                CornerRadius = UDim.new(0, 8),
                TopLeftRadius = 8,
                TopRightRadius = 8,
                BottomLeftRadius = 0,
                BottomRightRadius = 0
            }),
            
            -- Window Controls (Close/Minimize)
            Utility:Create("Frame", {
                Name = "WindowControls",
                Position = UDim2.new(0, 12, 0, 12),
                Size = UDim2.new(0, 50, 0, 20),
                BackgroundTransparency = 1
            }, {
                Utility:Create("UIListLayout", {
                    FillDirection = Enum.FillDirection.Horizontal,
                    Padding = UDim.new(0, 8),
                    SortOrder = Enum.SortOrder.LayoutOrder
                }),
                
                -- Minimize Button (Yellow)
                Utility:Create("TextButton", {
                    Name = "MinimizeButton",
                    Size = UDim2.new(0, 16, 0, 16),
                    BackgroundColor3 = Themes.MinimizeButton,
                    BorderSizePixel = 0,
                    Text = "",
                    AutoButtonColor = false,
                    LayoutOrder = 1
                }, {
                    Utility:Create("UICorner", {CornerRadius = UDim.new(1, 0)}),
                    Utility:Create("UIStroke", {
                        Color = Color3.fromRGB(180, 140, 30),
                        Thickness = 1
                    })
                }),
                
                -- Close Button (Red)
                Utility:Create("TextButton", {
                    Name = "CloseButton",
                    Size = UDim2.new(0, 16, 0, 16),
                    BackgroundColor3 = Themes.CloseButton,
                    BorderSizePixel = 0,
                    Text = "",
                    AutoButtonColor = false,
                    LayoutOrder = 2
                }, {
                    Utility:Create("UICorner", {CornerRadius = UDim.new(1, 0)}),
                    Utility:Create("UIStroke", {
                        Color = Color3.fromRGB(180, 40, 40),
                        Thickness = 1
                    })
                })
            }),
            
            -- First Separator Line
            Utility:Create("Frame", {
                Name = "Separator1",
                Position = UDim2.new(0, 12, 0, 40),
                Size = UDim2.new(1, -24, 0, 1),
                BackgroundColor3 = Themes.DarkContrast,
                BorderSizePixel = 0
            }),
            
            -- Title and Version Area
            Utility:Create("Frame", {
                Name = "TitleArea",
                Position = UDim2.new(0, 0, 0, 41),
                Size = UDim2.new(1, 0, 0, 49),
                BackgroundTransparency = 1
            }, {
                -- Title
                Utility:Create("TextLabel", {
                    Name = "TitleLabel",
                    Position = UDim2.new(0, 15, 0, 5),
                    Size = UDim2.new(1, -30, 0, 24),
                    BackgroundTransparency = 1,
                    Text = title or "Z3XHub",
                    TextColor3 = Themes.TextColor,
                    Font = Enum.Font.GothamBold,
                    TextSize = 20,
                    TextXAlignment = Enum.TextXAlignment.Left
                }),
                
                -- Version
                Utility:Create("TextLabel", {
                    Name = "VersionLabel",
                    Position = UDim2.new(0, 15, 0, 30),
                    Size = UDim2.new(1, -30, 0, 16),
                    BackgroundTransparency = 1,
                    Text = "Version 6.0a",
                    TextColor3 = Color3.fromRGB(150, 150, 150),
                    Font = Enum.Font.Gotham,
                    TextSize = 14,
                    TextXAlignment = Enum.TextXAlignment.Left
                }),
                
                -- Second Separator Line
                Utility:Create("Frame", {
                    Name = "Separator2",
                    Position = UDim2.new(0, 12, 1, -1),
                    Size = UDim2.new(1, -24, 0, 1),
                    BackgroundColor3 = Themes.DarkContrast,
                    BorderSizePixel = 0
                })
            })
        }),
        
        -- Sidebar for Pages
        Utility:Create("Frame", {
            Name = "Sidebar",
            Position = UDim2.new(0, 0, 0, 90),
            Size = UDim2.new(0, 180, 1, -90),
            BackgroundColor3 = Themes.DarkBackground,
            BorderSizePixel = 0
        }, {
            Utility:Create("UICorner", {
                CornerRadius = UDim.new(0, 8),
                TopLeftRadius = 0,
                TopRightRadius = 8,
                BottomLeftRadius = 0,
                BottomRightRadius = 0
            }),
            
            Utility:Create("ScrollingFrame", {
                Name = "PagesContainer",
                Active = true,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 1, 0),
                CanvasSize = UDim2.new(0, 0, 0, 0),
                ScrollBarThickness = 3,
                ScrollBarImageColor3 = Themes.DarkContrast,
                ScrollBarImageTransparency = 0.5
            }, {
                Utility:Create("UIListLayout", {
                    SortOrder = Enum.SortOrder.LayoutOrder,
                    Padding = UDim.new(0, 10)
                }),
                Utility:Create("UIPadding", {
                    PaddingTop = UDim.new(0, 15),
                    PaddingLeft = UDim.new(0, 12),
                    PaddingRight = UDim.new(0, 12),
                    PaddingBottom = UDim.new(0, 15)
                })
            })
        }),
        
        -- Content Area
        Utility:Create("Frame", {
            Name = "ContentArea",
            Position = UDim2.new(0, 180, 0, 90),
            Size = UDim2.new(1, -180, 1, -90),
            BackgroundColor3 = Themes.Background,
            BorderSizePixel = 0
        }, {
            Utility:Create("Frame", {
                Name = "PageContainer",
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                ClipsDescendants = true
            })
        })
    })
    
    mainFrame.Parent = container
    
    -- Enable dragging from top bar
    Utility:EnableDragging(mainFrame.TopBar, mainFrame)
    
    -- Setup close button
    local closeBtn = mainFrame.TopBar.WindowControls.CloseButton
    closeBtn.MouseButton1Click:Connect(function()
        container:Destroy()
    end)
    
    closeBtn.MouseEnter:Connect(function()
        Utility:Tween(closeBtn, {
            Size = UDim2.new(0, 18, 0, 18),
            BackgroundColor3 = Color3.fromRGB(255, 80, 80)
        }, 0.2)
    end)
    
    closeBtn.MouseLeave:Connect(function()
        Utility:Tween(closeBtn, {
            Size = UDim2.new(0, 16, 0, 16),
            BackgroundColor3 = Themes.CloseButton
        }, 0.2)
    end)
    
    -- Setup minimize button
    local minimizeBtn = mainFrame.TopBar.WindowControls.MinimizeButton
    local isMinimized = false
    local originalSize = DefaultUISize
    local originalPosition = mainFrame.Position
    
    minimizeBtn.MouseButton1Click:Connect(function()
        if isMinimized then
            -- Restore
            Utility:Tween(mainFrame, {
                Size = originalSize,
                Position = originalPosition
            }, 0.3)
        else
            -- Minimize
            originalSize = mainFrame.Size
            originalPosition = mainFrame.Position
            Utility:Tween(mainFrame, {
                Size = UDim2.new(0, 800, 0, 90),
                Position = originalPosition
            }, 0.3)
        end
        isMinimized = not isMinimized
    end)
    
    minimizeBtn.MouseEnter:Connect(function()
        Utility:Tween(minimizeBtn, {
            Size = UDim2.new(0, 18, 0, 18),
            BackgroundColor3 = Color3.fromRGB(255, 200, 60)
        }, 0.2)
    end)
    
    minimizeBtn.MouseLeave:Connect(function()
        Utility:Tween(minimizeBtn, {
            Size = UDim2.new(0, 16, 0, 16),
            BackgroundColor3 = Themes.MinimizeButton
        }, 0.2)
    end)
    
    local lib = setmetatable({
        Container = container,
        MainFrame = mainFrame,
        PagesContainer = mainFrame.Sidebar.PagesContainer,
        ContentArea = mainFrame.ContentArea.PageContainer,
        Pages = {},
        SelectedPage = nil,
        Keybinds = keybindSystem.Keybinds,
        EndedCallbacks = keybindSystem.EndedCallbacks,
        ColorPickers = {},
        Modules = {},
        Binds = {},
        Lists = {},
        ActiveNotification = nil,
        ActivePicker = nil,
        IsToggling = false,
        SavedPosition = nil,
        LastNotificationPosition = nil,
        IsMinimized = false
    }, Library)
    
    Utility:OnDragEnd(lib.EndedCallbacks, function() end)
    
    return lib
end

function Library:AddPage(title, icon, isDefault)
    local page = self:CreatePage(title, icon)
    table.insert(self.Pages, page)
    if isDefault or #self.Pages == 1 then
        task.defer(function()
            for _ = 1, 3 do
                RunService.Heartbeat:Wait()
            end
            self:SelectPage(page, true)
        end)
    end
    page.Button.MouseButton1Click:Connect(function()
        page.NeedsRefresh = true
        self:SelectPage(page, true)
    end)
    return page
end

function Library:CreatePage(title, icon)
    icon = "rbxassetid://" .. tostring(icon or 5012544693)
    
    -- Create page button with new design
    local button = Utility:Create("TextButton", {
        Name = title,
        Parent = self.PagesContainer,
        BackgroundColor3 = Themes.DarkBackground,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 42),
        ZIndex = 3,
        AutoButtonColor = false,
        Text = "",
        Font = Enum.Font.SourceSansSemibold
    }, {
        Utility:Create("UICorner", {CornerRadius = UDim.new(0, 6)}),
        
        -- Selection Indicator (Left border)
        Utility:Create("Frame", {
            Name = "SelectionIndicator",
            Position = UDim2.new(0, -8, 0, 0),
            Size = UDim2.new(0, 4, 1, 0),
            BackgroundColor3 = Themes.Accent,
            BorderSizePixel = 0,
            BackgroundTransparency = 1
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 2)})
        }),
        
        -- Title
        Utility:Create("TextLabel", {
            Name = "Title",
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            ZIndex = 3,
            Font = Enum.Font.Gotham,
            Text = title,
            TextColor3 = Color3.fromRGB(180, 180, 180),
            TextSize = 15,
            TextTransparency = 0.2,
            TextXAlignment = Enum.TextXAlignment.Left
        }, {
            Utility:Create("UIPadding", {
                PaddingLeft = UDim.new(0, 15)
            })
        }),
        
        -- Icon
        Utility:Create("ImageLabel", {
            Name = "Icon",
            AnchorPoint = Vector2.new(0, 0.5),
            BackgroundTransparency = 1,
            Position = UDim2.new(1, -35, 0.5, 0),
            Size = UDim2.new(0, 24, 0, 24),
            ZIndex = 3,
            Image = icon,
            ImageColor3 = Color3.fromRGB(180, 180, 180),
            ImageTransparency = 0.2
        })
    })

    -- Create page container
    local container = Utility:Create("ScrollingFrame", {
        Name = title,
        Parent = self.ContentArea,
        Active = true,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(1, 0, 1, 0),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ScrollBarThickness = 3,
        ScrollBarImageColor3 = Themes.DarkContrast,
        Visible = false
    }, {
        Utility:Create("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 12)
        }),
        Utility:Create("UIPadding", {
            PaddingTop = UDim.new(0, 10),
            PaddingLeft = UDim.new(0, 10),
            PaddingRight = UDim.new(0, 10),
            PaddingBottom = UDim.new(0, 10)
        })
    })

    return {
        Library = self,
        Container = container,
        Button = button,
        Sections = {},
        NeedsRefresh = true,
        UIListLayout = container:FindFirstChildOfClass("UIListLayout"),
        LastPosition = nil
    }
end

function Library:SelectPage(page, instant)
    if self.SelectedPage then
        self.SelectedPage.Container.Visible = false
        Utility:Tween(self.SelectedPage.Button, {
            BackgroundColor3 = Themes.DarkBackground
        }, instant and 0 or 0.2)
        Utility:Tween(self.SelectedPage.Button.Title, {
            TextColor3 = Color3.fromRGB(180, 180, 180),
            TextTransparency = 0.2
        }, instant and 0 or 0.2)
        Utility:Tween(self.SelectedPage.Button.Icon, {
            ImageColor3 = Color3.fromRGB(180, 180, 180),
            ImageTransparency = 0.2
        }, instant and 0 or 0.2)
        Utility:Tween(self.SelectedPage.Button.SelectionIndicator, {
            BackgroundTransparency = 1
        }, instant and 0 or 0.2)
    end
    
    page.Container.Visible = true
    if page.NeedsRefresh then
        task.wait(0.1)
        if page.UIListLayout then
            page.UIListLayout:ApplyLayout()
        end
        for _, section in pairs(page.Sections) do
            if section.UIListLayout then
                section.UIListLayout:ApplyLayout()
            end
        end
        task.wait(0.1)
        self:PageResize(page)
        page.NeedsRefresh = false
    end
    
    Utility:Tween(page.Button, {
        BackgroundColor3 = Themes.Selected
    }, instant and 0 or 0.2)
    Utility:Tween(page.Button.Title, {
        TextColor3 = Themes.TextColor,
        TextTransparency = 0
    }, instant and 0 or 0.2)
    Utility:Tween(page.Button.Icon, {
        ImageColor3 = Themes.TextColor,
        ImageTransparency = 0
    }, instant and 0 or 0.2)
    Utility:Tween(page.Button.SelectionIndicator, {
        BackgroundTransparency = 0
    }, instant and 0 or 0.2)
    
    self.SelectedPage = page
end

function Library:ToggleVisibility()
    if self.IsToggling then
        return
    end
    self.IsToggling = true
    local main = self.MainFrame
    local topbar = main.TopBar
    
    if self.SavedPosition then
        -- Restore
        Utility:Tween(main, {Size = DefaultUISize, Position = self.SavedPosition}, 0.3)
        task.wait(0.3)
        self.SavedPosition = nil
        self.IsMinimized = false
    else
        -- Minimize to top bar only
        self.SavedPosition = main.Position
        Utility:Tween(main, {Size = UDim2.new(0, 800, 0, 90), Position = self.SavedPosition}, 0.3)
        self.IsMinimized = true
    end
    self.IsToggling = false
end

function Library:SetTheme(themeKey, newColor)
    Themes[themeKey] = newColor
end

function Library:ShowNotification(title, text, callback)
    if self.ActiveNotification then
        self.ActiveNotification()
    end
    title = title or "Notification"
    text = text or ""
    local notification = Utility:Create("ImageLabel", {
        Name = "Notification",
        Parent = self.Container,
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 200, 0, 60),
        Image = "rbxassetid://5028857472",
        ImageColor3 = Color3.fromRGB(0, 0, 0),
        ImageTransparency = 0.25,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(4, 4, 296, 296),
        ZIndex = 3,
        ClipsDescendants = true
    }, {
        Utility:Create("ImageLabel", {
            Name = "Flash",
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Image = "rbxassetid://4641149554",
            ImageColor3 = Themes.TextColor,
            ImageTransparency = 0.5,
            ZIndex = 5
        }),
        Utility:Create("TextLabel", {
            Name = "Title",
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 10, 0, 8),
            Size = UDim2.new(1, -40, 0, 16),
            ZIndex = 4,
            Font = Enum.Font.SourceSansSemibold,
            TextColor3 = Themes.TextColor,
            TextSize = 16,
            TextXAlignment = Enum.TextXAlignment.Left,
            Text = title
        }),
        Utility:Create("TextLabel", {
            Name = "Text",
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 10, 1, -24),
            Size = UDim2.new(1, -40, 0, 16),
            ZIndex = 4,
            Font = Enum.Font.Gotham,
            TextColor3 = Themes.TextColor,
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Left,
            Text = text
        }),
        Utility:Create("ImageButton", {
            Name = "Accept",
            BackgroundTransparency = 1,
            Position = UDim2.new(1, -26, 0, 8),
            Size = UDim2.new(0, 16, 0, 16),
            Image = "rbxassetid://5012538259",
            ImageColor3 = Themes.TextColor,
            ZIndex = 4
        }),
        Utility:Create("ImageButton", {
            Name = "Decline",
            BackgroundTransparency = 1,
            Position = UDim2.new(1, -26, 1, -24),
            Size = UDim2.new(0, 16, 0, 16),
            Image = "rbxassetid://5012538583",
            ImageColor3 = Themes.TextColor,
            ZIndex = 4
        })
    })

    Utility:EnableDragging(notification, notification)

    local padding = 10
    local textSize = TextService:GetTextSize(text, 12, Enum.Font.Gotham, Vector2.new(math.huge, 16))

    notification.Position = self.LastNotificationPosition or UDim2.new(0, padding, 1, -(notification.AbsoluteSize.Y + padding))
    notification.Size = UDim2.new(0, 0, 0, 60)

    Utility:Tween(notification, {Size = UDim2.new(0, textSize.X + 70, 0, 60)}, 0.2)
    task.wait(0.2)

    notification.ClipsDescendants = false
    Utility:Tween(notification.Flash, {Size = UDim2.new(0, 0, 0, 60), Position = UDim2.new(1, 0, 0, 0)}, 0.2)

    local active = true
    local close = function()
        if not active then
            return
        end
        active = false
        notification.ClipsDescendants = true

        self.LastNotificationPosition = notification.Position
        notification.Flash.Position = UDim2.new(0, 0, 0, 0)
        Utility:Tween(notification.Flash, {Size = UDim2.new(1, 0, 1, 0)}, 0.2)

        task.wait(0.2)
        Utility:Tween(notification, {Size = UDim2.new(0, 0, 0, 60), Position = notification.Position + UDim2.new(0, textSize.X + 70, 0, 0)}, 0.2)

        task.wait(0.2)
        notification:Destroy()
        self.ActiveNotification = nil
    end

    self.ActiveNotification = close

    notification.Accept.MouseButton1Click:Connect(function()
        if not active then
            return
        end
        if callback then
            callback(true)
        end
        close()
    end)

    notification.Decline.MouseButton1Click:Connect(function()
        if not active then
            return
        end
        if callback then
            callback(false)
        end
        close()
    end)
    return close
end

function Library:PageAddSection(page, title)
    local section = self:CreateSection(page, title)
    table.insert(page.Sections, section)
    page.NeedsRefresh = true
    self:PageResize(page)
    if self.SelectedPage == page then
        task.defer(function()
            self:SelectPage(page, true)
        end)
    end
    return section
end

function Library:CreateSection(page, title)
    local wrapper = Utility:Create("Frame", {
        Name = title,
        Parent = page.Container,
        Size = UDim2.new(1, 0, 0, 45),
        ZIndex = 2,
        BackgroundTransparency = 1,
        ClipsDescendants = true
    }, {})

    local box = Utility:Create("Frame", {
        Name = title .. "Box",
        Parent = wrapper,
        Position = UDim2.new(0, 0, 0, 0),
        AnchorPoint = Vector2.new(0, 0),
        Size = UDim2.new(1, 0, 0, 45),
        ZIndex = 2,
        BackgroundColor3 = Themes.DarkContrast,
        ClipsDescendants = true
    }, {
        Utility:Create("UICorner", {CornerRadius = UDim.new(0, 6)}),
        Utility:Create("UIStroke", {
            Color = Themes.LightContrast,
            Thickness = 1,
            Transparency = 0.3
        }),
        
        Utility:Create("Frame", {
            Name = "InnerContainer",
            Active = true,
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            Position = UDim2.new(0, 8, 0, 8),
            Size = UDim2.new(1, -16, 1, -16)
        }, {
            Utility:Create("TextLabel", {
                Name = "Title",
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 0, 20),
                ZIndex = 2,
                Font = Enum.Font.GothamBold,
                Text = title,
                TextColor3 = Themes.TextColor,
                TextSize = 16,
                TextXAlignment = Enum.TextXAlignment.Left,
                TextTransparency = 0
            }),
            Utility:Create("ScrollingFrame", {
                Name = "ScrollingFrame",
                Active = true,
                BackgroundTransparency = 1,
                BorderSizePixel = 0,
                Position = UDim2.new(0, 0, 0, 25),
                Size = UDim2.new(1, 0, 1, -25),
                CanvasSize = UDim2.new(0, 0, 0, 0),
                ScrollBarThickness = 3,
                ScrollBarImageColor3 = Themes.DarkContrast,
                ZIndex = 5
            }, {
                Utility:Create("UIListLayout", {
                    SortOrder = Enum.SortOrder.LayoutOrder,
                    Padding = UDim.new(0, 6)
                })
            })
        })
    })

    local scrollingFrame = box.InnerContainer.ScrollingFrame
    local uiListLayout = scrollingFrame:FindFirstChildOfClass("UIListLayout")

    local section = {
        Page = page,
        Container = box.InnerContainer,
        ScrollingFrame = scrollingFrame,
        UIListLayout = uiListLayout,
        ColorPickers = {},
        Modules = {},
        Binds = {},
        Lists = {}
    }

    section.addButton = function(s, title, callback) return self:SectionAddButton(s, title, callback) end
    section.addToggle = function(s, title, default, callback) return self:SectionAddToggle(s, title, default, callback) end
    section.addTextbox = function(s, title, default, callback) return self:SectionAddTextbox(s, title, default, callback) end
    section.addKeybind = function(s, title, default, callback, changedCallback) return self:SectionAddKeybind(s, title, default, callback, changedCallback) end
    section.addColorpicker = function(s, title, default, callback) return self:SectionAddColorPicker(s, title, default, callback) end
    section.addSlider = function(s, title, default, min, max, callback) return self:SectionAddSlider(s, title, default, min, max, callback) end
    section.addDropdown = function(s, title, list, callback, default) return self:SectionAddDropdown(s, title, list, callback, default) end
    section.addMultiDropdown = function(s, title, list, callback) return self:SectionAddMultiDropdown(s, title, list, callback) end
    section.addLabel = function(s, title) return self:SectionAddLabel(s, title) end

    if uiListLayout then
        uiListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            self:SectionResize(section)
        end)
    end

    return section
end

function Library:SectionResize(section)
    if not section or not section.UIListLayout then
        return
    end
    task.wait(0.1)
    local totalSize = section.UIListLayout.AbsoluteContentSize.Y
    local titleHeight = 25
    local containerPadding = 16
    local contentHeight = totalSize + titleHeight
    section.ScrollingFrame.CanvasSize = UDim2.new(0, 0, 0, totalSize)
    local wrapper = section.Container.Parent.Parent
    local box = section.Container.Parent
    if wrapper and box then
        local newHeight = math.min(1000, math.max(45, contentHeight + containerPadding))
        wrapper.Size = UDim2.new(1, 0, 0, newHeight)
        box.Size = UDim2.new(1, 0, 0, newHeight)
        box.Position = UDim2.new(0, 0, 0, 0)
        if contentHeight + containerPadding > 1000 then
            section.ScrollingFrame.ScrollBarImageTransparency = 0
        else
            section.ScrollingFrame.ScrollBarImageTransparency = 1
        end
    end
    self:PageResize(section.Page)
end

function Library:SectionAddButton(section, title, callback)
    local button = Utility:Create("TextButton", {
        Name = "Button",
        Parent = section.ScrollingFrame,
        BackgroundColor3 = Themes.LightContrast,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 36),
        ZIndex = 2,
        Text = "",
        AutoButtonColor = false
    }, {
        Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
        Utility:Create("UIStroke", {
            Color = Themes.DarkContrast,
            Thickness = 1
        }),
        
        Utility:Create("TextLabel", {
            Name = "Title",
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            ZIndex = 3,
            Font = Enum.Font.Gotham,
            Text = title,
            TextColor3 = Themes.TextColor,
            TextSize = 14,
            TextTransparency = 0.1
        })
    })

    table.insert(section.Modules, button)

    local debounce = false
    button.MouseButton1Click:Connect(function()
        if debounce then
            return
        end
        Utility:PopEffect(button, 10)
        debounce = true

        local originalTextSize = button.Title.TextSize

        Utility:Tween(button.Title, {TextSize = 12}, 0.1)
        task.wait(0.1)

        local success, err = pcall(function()
            if callback then
                callback(function(...)
                    self:UpdateButton(button, ...)
                end)
            end
        end)

        Utility:Tween(button.Title, {TextSize = originalTextSize}, 0.1)

        if not success then
            warn("Button callback error: " .. tostring(err))
            self:ShowNotification("Error", "Button action failed: " .. tostring(err))
        end

        debounce = false
    end)

    -- Hover effects
    button.MouseEnter:Connect(function()
        Utility:Tween(button, {BackgroundColor3 = Themes.Accent}, 0.2)
    end)
    
    button.MouseLeave:Connect(function()
        Utility:Tween(button, {BackgroundColor3 = Themes.LightContrast}, 0.2)
    end)

    task.defer(function()
        self:SectionResize(section)
    end)

    return button
end

function Library:SectionAddToggle(section, title, default, callback)
    local toggle = Utility:Create("TextButton", {
        Name = "Toggle",
        Parent = section.ScrollingFrame,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 36),
        ZIndex = 2,
        Text = "",
        AutoButtonColor = false
    }, {
        Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
        
        Utility:Create("TextLabel", {
            Name = "Title",
            AnchorPoint = Vector2.new(0, 0.5),
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 10, 0.5, 1),
            Size = UDim2.new(0.6, 0, 1, 0),
            ZIndex = 3,
            Font = Enum.Font.Gotham,
            Text = title,
            TextColor3 = Themes.TextColor,
            TextSize = 14,
            TextTransparency = 0.1,
            TextXAlignment = Enum.TextXAlignment.Left
        }),
        
        -- Toggle switch
        Utility:Create("Frame", {
            Name = "ToggleSwitch",
            AnchorPoint = Vector2.new(1, 0.5),
            Position = UDim2.new(1, -10, 0.5, 0),
            Size = UDim2.new(0, 50, 0, 26),
            BackgroundColor3 = Themes.LightContrast,
            BorderSizePixel = 0
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 13)}),
            
            Utility:Create("Frame", {
                Name = "ToggleCircle",
                AnchorPoint = Vector2.new(0.5, 0.5),
                Position = default and UDim2.new(0.75, 0, 0.5, 0) or UDim2.new(0.25, 0, 0.5, 0),
                Size = UDim2.new(0, 20, 0, 20),
                BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                BorderSizePixel = 0
            }, {
                Utility:Create("UICorner", {CornerRadius = UDim.new(1, 0)}),
                Utility:Create("UIStroke", {
                    Color = Themes.DarkContrast,
                    Thickness = 1
                })
            })
        })
    })

    table.insert(section.Modules, toggle)

    local active = default or false
    local toggleSwitch = toggle.ToggleSwitch
    local toggleCircle = toggleSwitch.ToggleCircle
    
    -- Update visual state
    local function updateToggle()
        if active then
            Utility:Tween(toggleSwitch, {BackgroundColor3 = Themes.Accent}, 0.2)
            Utility:Tween(toggleCircle, {Position = UDim2.new(0.75, 0, 0.5, 0)}, 0.2)
        else
            Utility:Tween(toggleSwitch, {BackgroundColor3 = Themes.LightContrast}, 0.2)
            Utility:Tween(toggleCircle, {Position = UDim2.new(0.25, 0, 0.5, 0)}, 0.2)
        end
    end
    
    updateToggle()

    toggle.MouseButton1Click:Connect(function()
        active = not active
        updateToggle()

        if callback then
            local success, err = pcall(function()
                callback(active)
            end)

            if not success then
                warn("Toggle callback error: " .. tostring(err))
                self:ShowNotification("Error", "Toggle action failed: " .. tostring(err))

                active = not active
                updateToggle()
            end
        end
    end)

    -- Hover effect
    toggle.MouseEnter:Connect(function()
        Utility:Tween(toggle, {BackgroundColor3 = Color3.fromRGB(30, 30, 30)}, 0.2)
    end)
    
    toggle.MouseLeave:Connect(function()
        Utility:Tween(toggle, {BackgroundTransparency = 1}, 0.2)
    end)

    task.defer(function()
        self:SectionResize(section)
    end)

    return toggle
end

function Library:SectionAddTextbox(section, title, default, callback)
    local textbox = Utility:Create("Frame", {
        Name = "Textbox",
        Parent = section.ScrollingFrame,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 36),
        ZIndex = 2
    }, {
        Utility:Create("TextLabel", {
            Name = "Title",
            AnchorPoint = Vector2.new(0, 0.5),
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 10, 0.5, 1),
            Size = UDim2.new(0.5, 0, 1, 0),
            ZIndex = 3,
            Font = Enum.Font.Gotham,
            Text = title,
            TextColor3 = Themes.TextColor,
            TextSize = 14,
            TextTransparency = 0.1,
            TextXAlignment = Enum.TextXAlignment.Left
        }),
        
        -- Textbox input
        Utility:Create("TextBox", {
            Name = "InputBox",
            AnchorPoint = Vector2.new(1, 0.5),
            Position = UDim2.new(1, -10, 0.5, 0),
            Size = UDim2.new(0, 150, 0, 28),
            BackgroundColor3 = Themes.LightContrast,
            BorderSizePixel = 0,
            TextColor3 = Themes.TextColor,
            Font = Enum.Font.Gotham,
            TextSize = 14,
            Text = default or "",
            PlaceholderText = "Type here...",
            PlaceholderColor3 = Color3.fromRGB(150, 150, 150),
            ClearTextOnFocus = false
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            Utility:Create("UIStroke", {
                Color = Themes.DarkContrast,
                Thickness = 1
            }),
            Utility:Create("UIPadding", {
                PaddingLeft = UDim.new(0, 8),
                PaddingRight = UDim.new(0, 8)
            })
        })
    })

    table.insert(section.Modules, textbox)

    local inputBox = textbox.InputBox

    inputBox:GetPropertyChangedSignal("Text"):Connect(function()
        if inputBox.Text ~= (default or "") then
            Utility:PopEffect(inputBox, 5)
        end
        if callback then
            local success, err = pcall(function()
                callback(inputBox.Text, nil, function(...)
                    self:UpdateTextbox(textbox, ...)
                end)
            end)
            if not success then
                warn("Textbox callback error: " .. tostring(err))
            end
        end
    end)

    inputBox.FocusLost:Connect(function()
        if callback then
            local success, err = pcall(function()
                callback(inputBox.Text, true, function(...)
                    self:UpdateTextbox(textbox, ...)
                end)
            end)
            if not success then
                warn("Textbox callback error: " .. tostring(err))
            end
        end
    end)

    task.defer(function()
        self:SectionResize(section)
    end)

    return textbox
end

function Library:SectionAddKeybind(section, title, default, callback, changedCallback)
    local keybind = Utility:Create("Frame", {
        Name = "Keybind",
        Parent = section.ScrollingFrame,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 36),
        ZIndex = 2
    }, {
        Utility:Create("TextLabel", {
            Name = "Title",
            AnchorPoint = Vector2.new(0, 0.5),
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 10, 0.5, 1),
            Size = UDim2.new(0.6, 0, 1, 0),
            ZIndex = 3,
            Font = Enum.Font.Gotham,
            Text = title,
            TextColor3 = Themes.TextColor,
            TextSize = 14,
            TextTransparency = 0.1,
            TextXAlignment = Enum.TextXAlignment.Left
        }),
        
        -- Keybind display
        Utility:Create("TextButton", {
            Name = "KeyButton",
            AnchorPoint = Vector2.new(1, 0.5),
            Position = UDim2.new(1, -10, 0.5, 0),
            Size = UDim2.new(0, 120, 0, 28),
            BackgroundColor3 = Themes.LightContrast,
            BorderSizePixel = 0,
            Text = default and default.Name or "None",
            TextColor3 = Themes.TextColor,
            Font = Enum.Font.Gotham,
            TextSize = 14,
            AutoButtonColor = false
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            Utility:Create("UIStroke", {
                Color = Themes.DarkContrast,
                Thickness = 1
            })
        })
    })

    table.insert(section.Modules, keybind)

    local keyButton = keybind.KeyButton
    local animate = function()
        Utility:PopEffect(keyButton, 5)
    end

    section.Binds[keybind] = {
        Callback = function()
            animate()
            if callback then
                callback(function(...)
                    self:UpdateKeybind(keybind, ...)
                end)
            end
        end
    }

    if default and callback then
        self:UpdateKeybind(keybind, nil, default)
    end

    local isListening = false
    keyButton.MouseButton1Click:Connect(function()
        if isListening then return end
        
        isListening = true
        animate()
        
        keyButton.Text = "..."
        keyButton.BackgroundColor3 = Themes.Accent
        
        local connection
        connection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
            if gameProcessed then return end
            
            if input.UserInputType == Enum.UserInputType.Keyboard then
                self:UpdateKeybind(keybind, nil, input.KeyCode)
                keyButton.BackgroundColor3 = Themes.LightContrast
                isListening = false
                connection:Disconnect()
                
                if changedCallback then
                    changedCallback(input, function(...)
                        self:UpdateKeybind(keybind, ...)
                    end)
                end
            elseif input.UserInputType == Enum.UserInputType.MouseButton1 then
                self:UpdateKeybind(keybind, nil, Enum.KeyCode.LeftControl)
                keyButton.BackgroundColor3 = Themes.LightContrast
                isListening = false
                connection:Disconnect()
            end
        end)
    end)

    -- Hover effect
    keyButton.MouseEnter:Connect(function()
        if not isListening then
            Utility:Tween(keyButton, {BackgroundColor3 = Color3.fromRGB(50, 50, 50)}, 0.2)
        end
    end)
    
    keyButton.MouseLeave:Connect(function()
        if not isListening then
            Utility:Tween(keyButton, {BackgroundColor3 = Themes.LightContrast}, 0.2)
        end
    end)

    task.defer(function()
        self:SectionResize(section)
    end)

    return keybind
end

function Library:SectionAddColorPicker(section, title, default, callback)
    local colorpicker = Utility:Create("Frame", {
        Name = "ColorPicker",
        Parent = section.ScrollingFrame,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 36),
        ZIndex = 2
    }, {
        Utility:Create("TextLabel", {
            Name = "Title",
            AnchorPoint = Vector2.new(0, 0.5),
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 10, 0.5, 1),
            Size = UDim2.new(0.6, 0, 1, 0),
            ZIndex = 3,
            Font = Enum.Font.Gotham,
            Text = title,
            TextColor3 = Themes.TextColor,
            TextSize = 14,
            TextTransparency = 0.1,
            TextXAlignment = Enum.TextXAlignment.Left
        }),
        
        -- Color preview
        Utility:Create("TextButton", {
            Name = "ColorButton",
            AnchorPoint = Vector2.new(1, 0.5),
            Position = UDim2.new(1, -10, 0.5, 0),
            Size = UDim2.new(0, 120, 0, 28),
            BackgroundColor3 = default or Color3.fromRGB(255, 255, 255),
            BorderSizePixel = 0,
            Text = "",
            AutoButtonColor = false
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            Utility:Create("UIStroke", {
                Color = Themes.DarkContrast,
                Thickness = 1
            }),
            
            Utility:Create("TextLabel", {
                Name = "ColorText",
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 1, 0),
                Text = "Pick Color",
                TextColor3 = Color3.fromRGB(0, 0, 0),
                Font = Enum.Font.GothamBold,
                TextSize = 12
            })
        })
    })

    -- Color picker tab (similar to original but styled)
    local tab = Utility:Create("Frame", {
        Name = "ColorPickerTab",
        Parent = self.Container,
        BackgroundColor3 = Themes.DarkContrast,
        BorderSizePixel = 0,
        Position = UDim2.new(0.5, 0, 0.5, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        Size = UDim2.new(0, 200, 0, 220),
        Visible = false,
        ZIndex = 100
    }, {
        Utility:Create("UICorner", {CornerRadius = UDim.new(0, 8)}),
        Utility:Create("UIStroke", {
            Color = Themes.BorderColor,
            Thickness = 1
        }),
        
        Utility:Create("TextLabel", {
            Name = "Title",
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 10, 0, 8),
            Size = UDim2.new(1, -40, 0, 20),
            ZIndex = 101,
            Font = Enum.Font.GothamBold,
            Text = title,
            TextColor3 = Themes.TextColor,
            TextSize = 16,
            TextXAlignment = Enum.TextXAlignment.Left
        }),
        
        Utility:Create("TextButton", {
            Name = "Close",
            AnchorPoint = Vector2.new(1, 0),
            Position = UDim2.new(1, -10, 0, 8),
            Size = UDim2.new(0, 20, 0, 20),
            BackgroundColor3 = Themes.CloseButton,
            BorderSizePixel = 0,
            Text = "X",
            TextColor3 = Color3.fromRGB(255, 255, 255),
            Font = Enum.Font.GothamBold,
            TextSize = 14,
            ZIndex = 101
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)})
        }),
        
        -- Color canvas area
        Utility:Create("Frame", {
            Name = "CanvasArea",
            Position = UDim2.new(0, 10, 0, 40),
            Size = UDim2.new(1, -20, 0, 120),
            BackgroundColor3 = Color3.fromRGB(255, 0, 0),
            BorderSizePixel = 0
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            Utility:Create("UIStroke", {
                Color = Themes.BorderColor,
                Thickness = 1
            })
        }),
        
        -- RGB inputs
        Utility:Create("Frame", {
            Name = "RGBInputs",
            Position = UDim2.new(0, 10, 0, 170),
            Size = UDim2.new(1, -20, 0, 40),
            BackgroundTransparency = 1
        }, {
            Utility:Create("UIListLayout", {
                FillDirection = Enum.FillDirection.Horizontal,
                HorizontalAlignment = Enum.HorizontalAlignment.Center,
                Padding = UDim.new(0, 10),
                SortOrder = Enum.SortOrder.LayoutOrder
            }),
            
            -- R Input
            Utility:Create("Frame", {
                Name = "RInput",
                Size = UDim2.new(0.3, 0, 1, 0),
                BackgroundTransparency = 1
            }, {
                Utility:Create("TextLabel", {
                    Name = "Label",
                    Size = UDim2.new(0.3, 0, 1, 0),
                    BackgroundTransparency = 1,
                    Text = "R:",
                    TextColor3 = Themes.TextColor,
                    Font = Enum.Font.Gotham,
                    TextSize = 14,
                    TextXAlignment = Enum.TextXAlignment.Left
                }),
                Utility:Create("TextBox", {
                    Name = "Value",
                    Position = UDim2.new(0.3, 0, 0, 0),
                    Size = UDim2.new(0.7, 0, 1, 0),
                    BackgroundColor3 = Themes.LightContrast,
                    BorderSizePixel = 0,
                    TextColor3 = Themes.TextColor,
                    Font = Enum.Font.Gotham,
                    TextSize = 14,
                    Text = "255",
                    PlaceholderText = "0-255"
                }, {
                    Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
                    Utility:Create("UIStroke", {
                        Color = Themes.BorderColor,
                        Thickness = 1
                    })
                })
            }),
            
            -- G Input
            Utility:Create("Frame", {
                Name = "GInput",
                Size = UDim2.new(0.3, 0, 1, 0),
                BackgroundTransparency = 1
            }, {
                Utility:Create("TextLabel", {
                    Name = "Label",
                    Size = UDim2.new(0.3, 0, 1, 0),
                    BackgroundTransparency = 1,
                    Text = "G:",
                    TextColor3 = Themes.TextColor,
                    Font = Enum.Font.Gotham,
                    TextSize = 14,
                    TextXAlignment = Enum.TextXAlignment.Left
                }),
                Utility:Create("TextBox", {
                    Name = "Value",
                    Position = UDim2.new(0.3, 0, 0, 0),
                    Size = UDim2.new(0.7, 0, 1, 0),
                    BackgroundColor3 = Themes.LightContrast,
                    BorderSizePixel = 0,
                    TextColor3 = Themes.TextColor,
                    Font = Enum.Font.Gotham,
                    TextSize = 14,
                    Text = "255",
                    PlaceholderText = "0-255"
                }, {
                    Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
                    Utility:Create("UIStroke", {
                        Color = Themes.BorderColor,
                        Thickness = 1
                    })
                })
            }),
            
            -- B Input
            Utility:Create("Frame", {
                Name = "BInput",
                Size = UDim2.new(0.3, 0, 1, 0),
                BackgroundTransparency = 1
            }, {
                Utility:Create("TextLabel", {
                    Name = "Label",
                    Size = UDim2.new(0.3, 0, 1, 0),
                    BackgroundTransparency = 1,
                    Text = "B:",
                    TextColor3 = Themes.TextColor,
                    Font = Enum.Font.Gotham,
                    TextSize = 14,
                    TextXAlignment = Enum.TextXAlignment.Left
                }),
                Utility:Create("TextBox", {
                    Name = "Value",
                    Position = UDim2.new(0.3, 0, 0, 0),
                    Size = UDim2.new(0.7, 0, 1, 0),
                    BackgroundColor3 = Themes.LightContrast,
                    BorderSizePixel = 0,
                    TextColor3 = Themes.TextColor,
                    Font = Enum.Font.Gotham,
                    TextSize = 14,
                    Text = "255",
                    PlaceholderText = "0-255"
                }, {
                    Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
                    Utility:Create("UIStroke", {
                        Color = Themes.BorderColor,
                        Thickness = 1
                    })
                })
            })
        })
    })

    Utility:EnableDragging(tab, tab)
    table.insert(section.Modules, colorpicker)

    local colorButton = colorpicker.ColorButton
    local colorText = colorButton.ColorText
    
    -- Update text color based on background for readability
    local function updateTextColor(color)
        local brightness = (color.R * 0.299 + color.G * 0.587 + color.B * 0.114)
        if brightness > 0.5 then
            colorText.TextColor3 = Color3.fromRGB(0, 0, 0)
        else
            colorText.TextColor3 = Color3.fromRGB(255, 255, 255)
        end
    end
    
    if default then
        updateTextColor(default)
    end

    local currentColor = default or Color3.fromRGB(255, 255, 255)
    
    section.ColorPickers[colorpicker] = {
        tab = tab,
        callback = function(newColor)
            currentColor = newColor
            colorButton.BackgroundColor3 = newColor
            updateTextColor(newColor)
            if callback then
                callback(newColor, function(...)
                    self:UpdateColorPicker(colorpicker, ...)
                end)
            end
        end
    }

    -- Show color picker tab
    local isPickerVisible = false
    colorButton.MouseButton1Click:Connect(function()
        if isPickerVisible then
            Utility:Tween(tab, {Size = UDim2.new(0, 0, 0, 0)}, 0.2)
            task.wait(0.2)
            tab.Visible = false
            isPickerVisible = false
        else
            tab.Visible = true
            tab.Size = UDim2.new(0, 0, 0, 0)
            tab.Position = UDim2.new(0.5, -100, 0.5, -110)
            Utility:Tween(tab, {Size = UDim2.new(0, 200, 0, 220)}, 0.2)
            isPickerVisible = true
        end
    end)

    -- Close button
    tab.Close.MouseButton1Click:Connect(function()
        Utility:Tween(tab, {Size = UDim2.new(0, 0, 0, 0)}, 0.2)
        task.wait(0.2)
        tab.Visible = false
        isPickerVisible = false
    end)

    -- RGB input handlers
    local rInput = tab.RGBInputs.RInput.Value
    local gInput = tab.RGBInputs.GInput.Value
    local bInput = tab.RGBInputs.BInput.Value
    
    local function updateColorFromInputs()
        local r = math.clamp(tonumber(rInput.Text) or 255, 0, 255)
        local g = math.clamp(tonumber(gInput.Text) or 255, 0, 255)
        local b = math.clamp(tonumber(bInput.Text) or 255, 0, 255)
        
        currentColor = Color3.fromRGB(r, g, b)
        colorButton.BackgroundColor3 = currentColor
        updateTextColor(currentColor)
        
        if callback then
            callback(currentColor, function(...)
                self:UpdateColorPicker(colorpicker, ...)
            end)
        end
    end
    
    rInput.FocusLost:Connect(updateColorFromInputs)
    gInput.FocusLost:Connect(updateColorFromInputs)
    bInput.FocusLost:Connect(updateColorFromInputs)

    task.defer(function()
        self:SectionResize(section)
    end)

    return colorpicker
end

function Library:SectionAddSlider(section, title, default, min, max, callback)
    local slider = Utility:Create("Frame", {
        Name = "Slider",
        Parent = section.ScrollingFrame,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 60),
        ZIndex = 2
    }, {
        Utility:Create("TextLabel", {
            Name = "Title",
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 10, 0, 6),
            Size = UDim2.new(1, -20, 0, 20),
            ZIndex = 3,
            Font = Enum.Font.Gotham,
            Text = title .. ": " .. tostring(default or min),
            TextColor3 = Themes.TextColor,
            TextSize = 14,
            TextTransparency = 0.1,
            TextXAlignment = Enum.TextXAlignment.Left
        }),
        
        -- Slider track
        Utility:Create("Frame", {
            Name = "SliderTrack",
            Position = UDim2.new(0, 10, 0, 35),
            Size = UDim2.new(1, -20, 0, 8),
            BackgroundColor3 = Themes.LightContrast,
            BorderSizePixel = 0
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            
            -- Slider fill
            Utility:Create("Frame", {
                Name = "SliderFill",
                Size = UDim2.new((default or min) / max, 0, 1, 0),
                BackgroundColor3 = Themes.Accent,
                BorderSizePixel = 0
            }, {
                Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)})
            }),
            
            -- Slider thumb
            Utility:Create("Frame", {
                Name = "SliderThumb",
                AnchorPoint = Vector2.new(0.5, 0.5),
                Position = UDim2.new((default or min) / max, 0, 0.5, 0),
                Size = UDim2.new(0, 16, 0, 16),
                BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                BorderSizePixel = 0
            }, {
                Utility:Create("UICorner", {CornerRadius = UDim.new(1, 0)}),
                Utility:Create("UIStroke", {
                    Color = Themes.Accent,
                    Thickness = 2
                })
            })
        }),
        
        -- Value display
        Utility:Create("TextBox", {
            Name = "ValueBox",
            AnchorPoint = Vector2.new(1, 0),
            Position = UDim2.new(1, -10, 0, 6),
            Size = UDim2.new(0, 60, 0, 20),
            BackgroundColor3 = Themes.LightContrast,
            BorderSizePixel = 0,
            TextColor3 = Themes.TextColor,
            Font = Enum.Font.Gotham,
            TextSize = 14,
            Text = tostring(default or min),
            PlaceholderText = "Value"
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            Utility:Create("UIStroke", {
                Color = Themes.BorderColor,
                Thickness = 1
            }),
            Utility:Create("UIPadding", {
                PaddingLeft = UDim.new(0, 8),
                PaddingRight = UDim.new(0, 8)
            })
        })
    })

    table.insert(section.Modules, slider)

    local sliderTrack = slider.SliderTrack
    local sliderFill = sliderTrack.SliderFill
    local sliderThumb = sliderTrack.SliderThumb
    local titleLabel = slider.Title
    local valueBox = slider.ValueBox
    
    local value = default or min
    local isDragging = false

    local function updateSlider(newValue)
        value = math.clamp(newValue, min, max)
        local percentage = (value - min) / (max - min)
        
        sliderFill.Size = UDim2.new(percentage, 0, 1, 0)
        sliderThumb.Position = UDim2.new(percentage, 0, 0.5, 0)
        titleLabel.Text = title .. ": " .. tostring(value)
        valueBox.Text = tostring(value)
        
        if callback then
            callback(value, function(...)
                self:UpdateSlider(slider, ...)
            end)
        end
    end

    -- Mouse dragging
    sliderTrack.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = true
            local x = (input.Position.X - sliderTrack.AbsolutePosition.X) / sliderTrack.AbsoluteSize.X
            updateSlider(min + (max - min) * x)
        end
    end)
    
    sliderTrack.InputChanged:Connect(function(input)
        if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local x = (input.Position.X - sliderTrack.AbsolutePosition.X) / sliderTrack.AbsoluteSize.X
            updateSlider(min + (max - min) * x)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = false
        end
    end)

    -- Textbox input
    valueBox.FocusLost:Connect(function()
        local num = tonumber(valueBox.Text)
        if num then
            updateSlider(num)
        else
            valueBox.Text = tostring(value)
        end
    end)

    task.defer(function()
        self:SectionResize(section)
    end)

    return slider
end

function Library:SectionAddDropdown(section, title, list, callback, default)
    local dropdown = Utility:Create("Frame", {
        Name = "Dropdown",
        Parent = section.ScrollingFrame,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 36),
        ClipsDescendants = true
    }, {
        Utility:Create("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 4)
        }),
        
        -- Dropdown header
        Utility:Create("TextButton", {
            Name = "DropdownHeader",
            Size = UDim2.new(1, 0, 0, 36),
            BackgroundColor3 = Themes.LightContrast,
            BorderSizePixel = 0,
            Text = "",
            AutoButtonColor = false
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            Utility:Create("UIStroke", {
                Color = Themes.BorderColor,
                Thickness = 1
            }),
            
            Utility:Create("TextLabel", {
                Name = "Title",
                AnchorPoint = Vector2.new(0, 0.5),
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 10, 0.5, 0),
                Size = UDim2.new(0.8, 0, 1, 0),
                ZIndex = 3,
                Font = Enum.Font.Gotham,
                Text = title,
                TextColor3 = Themes.TextColor,
                TextSize = 14,
                TextTransparency = 0.1,
                TextXAlignment = Enum.TextXAlignment.Left
            }),
            
            -- Arrow icon
            Utility:Create("ImageLabel", {
                Name = "Arrow",
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, -10, 0.5, 0),
                Size = UDim2.new(0, 20, 0, 20),
                BackgroundTransparency = 1,
                Image = "rbxassetid://6031091004",
                ImageColor3 = Themes.TextColor,
                Rotation = 0
            })
        }),
        
        -- Options container
        Utility:Create("Frame", {
            Name = "OptionsContainer",
            Size = UDim2.new(1, 0, 0, 0),
            BackgroundColor3 = Themes.DarkContrast,
            BorderSizePixel = 0,
            Visible = false,
            ClipsDescendants = true
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            Utility:Create("UIStroke", {
                Color = Themes.BorderColor,
                Thickness = 1
            }),
            
            Utility:Create("ScrollingFrame", {
                Name = "OptionsList",
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                BorderSizePixel = 0,
                CanvasSize = UDim2.new(0, 0, 0, 0),
                ScrollBarThickness = 3,
                ScrollBarImageColor3 = Themes.BorderColor
            }, {
                Utility:Create("UIListLayout", {
                    SortOrder = Enum.SortOrder.LayoutOrder,
                    Padding = UDim.new(0, 2)
                }),
                Utility:Create("UIPadding", {
                    PaddingTop = UDim.new(0, 5),
                    PaddingLeft = UDim.new(0, 5),
                    PaddingRight = UDim.new(0, 5),
                    PaddingBottom = UDim.new(0, 5)
                })
            })
        })
    })

    table.insert(section.Modules, dropdown)

    local dropdownHeader = dropdown.DropdownHeader
    local optionsContainer = dropdown.OptionsContainer
    local optionsList = optionsContainer.OptionsList
    local arrow = dropdownHeader.Arrow
    
    local isOpen = false
    local options = list or {}
    local selectedOption = default or (options[1] or "")
    
    -- Update header text
    dropdownHeader.Title.Text = selectedOption

    local function toggleDropdown()
        isOpen = not isOpen
        
        if isOpen then
            optionsContainer.Visible = true
            local optionCount = #options
            local containerHeight = math.min(optionCount * 32 + 10, 150)
            Utility:Tween(optionsContainer, {Size = UDim2.new(1, 0, 0, containerHeight)}, 0.2)
            Utility:Tween(arrow, {Rotation = 180}, 0.2)
            Utility:Tween(dropdown, {Size = UDim2.new(1, 0, 0, 36 + containerHeight + 4)}, 0.2)
        else
            Utility:Tween(optionsContainer, {Size = UDim2.new(1, 0, 0, 0)}, 0.2)
            Utility:Tween(arrow, {Rotation = 0}, 0.2)
            Utility:Tween(dropdown, {Size = UDim2.new(1, 0, 0, 36)}, 0.2)
            task.wait(0.2)
            optionsContainer.Visible = false
        end
    end

    dropdownHeader.MouseButton1Click:Connect(toggleDropdown)
    
    -- Create option buttons
    for _, option in ipairs(options) do
        local optionButton = Utility:Create("TextButton", {
            Name = option,
            Size = UDim2.new(1, 0, 0, 30),
            BackgroundColor3 = Themes.LightContrast,
            BorderSizePixel = 0,
            Text = "",
            AutoButtonColor = false
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            
            Utility:Create("TextLabel", {
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = option,
                TextColor3 = Themes.TextColor,
                Font = Enum.Font.Gotham,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            }, {
                Utility:Create("UIPadding", {
                    PaddingLeft = UDim.new(0, 10)
                })
            })
        })
        
        optionButton.MouseEnter:Connect(function()
            Utility:Tween(optionButton, {BackgroundColor3 = Themes.Accent}, 0.2)
        end)
        
        optionButton.MouseLeave:Connect(function()
            Utility:Tween(optionButton, {BackgroundColor3 = Themes.LightContrast}, 0.2)
        end)
        
        optionButton.MouseButton1Click:Connect(function()
            selectedOption = option
            dropdownHeader.Title.Text = selectedOption
            toggleDropdown()
            
            if callback then
                callback(selectedOption, function(...)
                    self:UpdateDropdown(dropdown, ...)
                end)
            end
        end)
        
        optionButton.Parent = optionsList
    end
    
    -- Update options list size
    optionsList.CanvasSize = UDim2.new(0, 0, 0, #options * 32)

    dropdown:GetPropertyChangedSignal("Size"):Connect(function()
        self:SectionResize(section)
    end)

    task.defer(function()
        self:SectionResize(section)
    end)

    return dropdown
end

function Library:SectionAddMultiDropdown(section, title, list, callback)
    local dropdown = Utility:Create("Frame", {
        Name = "MultiDropdown",
        Parent = section.ScrollingFrame,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 36),
        ClipsDescendants = true
    }, {
        Utility:Create("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 4)
        }),
        
        -- Dropdown header
        Utility:Create("TextButton", {
            Name = "DropdownHeader",
            Size = UDim2.new(1, 0, 0, 36),
            BackgroundColor3 = Themes.LightContrast,
            BorderSizePixel = 0,
            Text = "",
            AutoButtonColor = false
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            Utility:Create("UIStroke", {
                Color = Themes.BorderColor,
                Thickness = 1
            }),
            
            Utility:Create("TextLabel", {
                Name = "Title",
                AnchorPoint = Vector2.new(0, 0.5),
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 10, 0.5, 0),
                Size = UDim2.new(0.8, 0, 1, 0),
                ZIndex = 3,
                Font = Enum.Font.Gotham,
                Text = title,
                TextColor3 = Themes.TextColor,
                TextSize = 14,
                TextTransparency = 0.1,
                TextXAlignment = Enum.TextXAlignment.Left
            }),
            
            -- Arrow icon
            Utility:Create("ImageLabel", {
                Name = "Arrow",
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, -10, 0.5, 0),
                Size = UDim2.new(0, 20, 0, 20),
                BackgroundTransparency = 1,
                Image = "rbxassetid://6031091004",
                ImageColor3 = Themes.TextColor,
                Rotation = 0
            })
        }),
        
        -- Options container
        Utility:Create("Frame", {
            Name = "OptionsContainer",
            Size = UDim2.new(1, 0, 0, 0),
            BackgroundColor3 = Themes.DarkContrast,
            BorderSizePixel = 0,
            Visible = false,
            ClipsDescendants = true
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            Utility:Create("UIStroke", {
                Color = Themes.BorderColor,
                Thickness = 1
            }),
            
            Utility:Create("ScrollingFrame", {
                Name = "OptionsList",
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                BorderSizePixel = 0,
                CanvasSize = UDim2.new(0, 0, 0, 0),
                ScrollBarThickness = 3,
                ScrollBarImageColor3 = Themes.BorderColor
            }, {
                Utility:Create("UIListLayout", {
                    SortOrder = Enum.SortOrder.LayoutOrder,
                    Padding = UDim.new(0, 2)
                }),
                Utility:Create("UIPadding", {
                    PaddingTop = UDim.new(0, 5),
                    PaddingLeft = UDim.new(0, 5),
                    PaddingRight = UDim.new(0, 5),
                    PaddingBottom = UDim.new(0, 5)
                })
            })
        })
    })

    local dropdownHeader = dropdown.DropdownHeader
    local optionsContainer = dropdown.OptionsContainer
    local optionsList = optionsContainer.OptionsList
    local arrow = dropdownHeader.Arrow
    
    local isOpen = false
    local options = list or {}
    local selectedOptions = {}
    
    -- Update header text
    local function updateHeaderText()
        if #selectedOptions == 0 then
            dropdownHeader.Title.Text = title
        else
            dropdownHeader.Title.Text = #selectedOptions .. " selected"
        end
    end
    
    updateHeaderText()

    local function toggleDropdown()
        isOpen = not isOpen
        
        if isOpen then
            optionsContainer.Visible = true
            local optionCount = #options
            local containerHeight = math.min(optionCount * 32 + 10, 150)
            Utility:Tween(optionsContainer, {Size = UDim2.new(1, 0, 0, containerHeight)}, 0.2)
            Utility:Tween(arrow, {Rotation = 180}, 0.2)
            Utility:Tween(dropdown, {Size = UDim2.new(1, 0, 0, 36 + containerHeight + 4)}, 0.2)
        else
            Utility:Tween(optionsContainer, {Size = UDim2.new(1, 0, 0, 0)}, 0.2)
            Utility:Tween(arrow, {Rotation = 0}, 0.2)
            Utility:Tween(dropdown, {Size = UDim2.new(1, 0, 0, 36)}, 0.2)
            task.wait(0.2)
            optionsContainer.Visible = false
        end
    end

    dropdownHeader.MouseButton1Click:Connect(toggleDropdown)
    
    -- Create option buttons with checkboxes
    for _, option in ipairs(options) do
        local isSelected = table.find(selectedOptions, option) ~= nil
        
        local optionButton = Utility:Create("Frame", {
            Name = option,
            Size = UDim2.new(1, 0, 0, 30),
            BackgroundTransparency = 1
        }, {
            Utility:Create("TextButton", {
                Name = "Button",
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundColor3 = Themes.LightContrast,
                BorderSizePixel = 0,
                Text = "",
                AutoButtonColor = false
            }, {
                Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
                
                -- Checkbox
                Utility:Create("Frame", {
                    Name = "Checkbox",
                    AnchorPoint = Vector2.new(0, 0.5),
                    Position = UDim2.new(0, 8, 0.5, 0),
                    Size = UDim2.new(0, 16, 0, 16),
                    BackgroundColor3 = isSelected and Themes.Accent or Themes.DarkContrast,
                    BorderSizePixel = 0
                }, {
                    Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
                    Utility:Create("UIStroke", {
                        Color = Themes.BorderColor,
                        Thickness = 1
                    }),
                    
                    Utility:Create("ImageLabel", {
                        Name = "CheckIcon",
                        AnchorPoint = Vector2.new(0.5, 0.5),
                        Position = UDim2.new(0.5, 0, 0.5, 0),
                        Size = UDim2.new(0, 12, 0, 12),
                        BackgroundTransparency = 1,
                        Image = "rbxassetid://6031091004",
                        ImageColor3 = Color3.fromRGB(255, 255, 255),
                        Visible = isSelected
                    })
                }),
                
                -- Option text
                Utility:Create("TextLabel", {
                    Name = "Text",
                    AnchorPoint = Vector2.new(0, 0.5),
                    Position = UDim2.new(0, 32, 0.5, 0),
                    Size = UDim2.new(1, -40, 1, 0),
                    BackgroundTransparency = 1,
                    Text = option,
                    TextColor3 = Themes.TextColor,
                    Font = Enum.Font.Gotham,
                    TextSize = 14,
                    TextXAlignment = Enum.TextXAlignment.Left
                })
            })
        })
        
        local button = optionButton.Button
        local checkbox = button.Checkbox
        local checkIcon = checkbox.CheckIcon
        
        button.MouseEnter:Connect(function()
            Utility:Tween(button, {BackgroundColor3 = Color3.fromRGB(50, 50, 50)}, 0.2)
        end)
        
        button.MouseLeave:Connect(function()
            Utility:Tween(button, {BackgroundColor3 = Themes.LightContrast}, 0.2)
        end)
        
        button.MouseButton1Click:Connect(function()
            local found = table.find(selectedOptions, option)
            if found then
                table.remove(selectedOptions, found)
                Utility:Tween(checkbox, {BackgroundColor3 = Themes.DarkContrast}, 0.2)
                checkIcon.Visible = false
            else
                table.insert(selectedOptions, option)
                Utility:Tween(checkbox, {BackgroundColor3 = Themes.Accent}, 0.2)
                checkIcon.Visible = true
            end
            
            updateHeaderText()
            
            if callback then
                callback(selectedOptions)
            end
        })
        
        optionButton.Parent = optionsList
    end
    
    -- Update options list size
    optionsList.CanvasSize = UDim2.new(0, 0, 0, #options * 32)

    dropdown:GetPropertyChangedSignal("Size"):Connect(function()
        self:SectionResize(section)
    end)

    task.defer(function()
        self:SectionResize(section)
    end)

    return dropdown
end

function Library:SectionAddLabel(section, title)
    local label = Utility:Create("TextLabel", {
        Name = "Label",
        Parent = section.ScrollingFrame,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 30),
        ZIndex = 2,
        Text = title,
        TextColor3 = Themes.TextColor,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextTransparency = 0.1,
        TextXAlignment = Enum.TextXAlignment.Left
    })

    table.insert(section.Modules, label)

    task.defer(function()
        self:SectionResize(section)
    end)

    return label
end

function Library:UpdateLabel(label, newText)
    if label and label:IsA("TextLabel") then
        label.Text = newText
    elseif label and label:FindFirstChild("Title") then
        label.Title.Text = newText
    end
end

function Library:UpdateButton(button, title)
    if button and button:FindFirstChild("Title") then
        button.Title.Text = title
    end
end

function Library:UpdateToggle(toggle, title, value)
    if title and toggle:FindFirstChild("Title") then
        toggle.Title.Text = title
    end
    
    if value ~= nil and toggle:FindFirstChild("ToggleSwitch") then
        local toggleSwitch = toggle.ToggleSwitch
        local toggleCircle = toggleSwitch.ToggleCircle
        
        if value then
            Utility:Tween(toggleSwitch, {BackgroundColor3 = Themes.Accent}, 0.2)
            Utility:Tween(toggleCircle, {Position = UDim2.new(0.75, 0, 0.5, 0)}, 0.2)
        else
            Utility:Tween(toggleSwitch, {BackgroundColor3 = Themes.LightContrast}, 0.2)
            Utility:Tween(toggleCircle, {Position = UDim2.new(0.25, 0, 0.5, 0)}, 0.2)
        end
    end
end

function Library:UpdateTextbox(textbox, title, value)
    if title and textbox:FindFirstChild("Title") then
        textbox.Title.Text = title
    end
    if value and textbox:FindFirstChild("InputBox") then
        textbox.InputBox.Text = value
    end
end

function Library:UpdateKeybind(keybind, title, key)
    if title and keybind:FindFirstChild("Title") then
        keybind.Title.Text = title
    end

    local section = self:FindSectionForKeybind(keybind)
    if not section then
        return
    end

    local bind = section.Binds[keybind]
    if bind and bind.Connection then
        bind.Connection:Unbind()
    end

    if key then
        if bind then
            bind.Connection = Utility:BindKey(self.Keybinds, key, bind.Callback)
        end
        if keybind:FindFirstChild("KeyButton") then
            keybind.KeyButton.Text = key.Name
        end
    else
        if keybind:FindFirstChild("KeyButton") then
            keybind.KeyButton.Text = "None"
        end
        if bind then
            bind.Connection = nil
        end
    end
end

function Library:UpdateColorPicker(colorpicker, title, color)
    local picker = self.ColorPickers[colorpicker]
    if not picker then return end
    
    local tab = picker.tab

    if title and colorpicker:FindFirstChild("Title") then
        colorpicker.Title.Text = title
    end
    if title and tab:FindFirstChild("Title") then
        tab.Title.Text = title
    end

    local color3
    if type(color) == "table" then
        color3 = Color3.fromHSV(unpack(color))
    else
        color3 = color
    end
    
    if colorpicker:FindFirstChild("ColorButton") then
        colorpicker.ColorButton.BackgroundColor3 = color3
        if colorpicker.ColorButton:FindFirstChild("ColorText") then
            local brightness = (color3.R * 0.299 + color3.G * 0.587 + color3.B * 0.114)
            if brightness > 0.5 then
                colorpicker.ColorButton.ColorText.TextColor3 = Color3.fromRGB(0, 0, 0)
            else
                colorpicker.ColorButton.ColorText.TextColor3 = Color3.fromRGB(255, 255, 255)
            end
        end
    end
    
    -- Update RGB inputs
    if tab:FindFirstChild("RGBInputs") then
        local r = math.floor(color3.R * 255)
        local g = math.floor(color3.G * 255)
        local b = math.floor(color3.B * 255)
        
        tab.RGBInputs.RInput.Value.Text = tostring(r)
        tab.RGBInputs.GInput.Value.Text = tostring(g)
        tab.RGBInputs.BInput.Value.Text = tostring(b)
    end
    
    if picker.callback then
        picker.callback(color3)
    end
end

function Library:UpdateSlider(slider, title, value, min, max, lvalue)
    if title and slider:FindFirstChild("Title") then
        slider.Title.Text = title
    end

    if value ~= nil and min ~= nil and max ~= nil then
        local percentage = (value - min) / (max - min)
        
        if slider:FindFirstChild("SliderTrack") then
            local sliderTrack = slider.SliderTrack
            local sliderFill = sliderTrack.SliderFill
            local sliderThumb = sliderTrack.SliderThumb
            
            Utility:Tween(sliderFill, {Size = UDim2.new(percentage, 0, 1, 0)}, 0.1)
            Utility:Tween(sliderThumb, {Position = UDim2.new(percentage, 0, 0.5, 0)}, 0.1)
        end
        
        if slider:FindFirstChild("Title") then
            slider.Title.Text = (title or slider.Title.Text):gsub(": %d+", "") .. ": " .. tostring(value)
        end
        
        if slider:FindFirstChild("ValueBox") then
            slider.ValueBox.Text = tostring(value)
        end
        
        if value ~= lvalue then
            Utility:PopEffect(slider, 10)
        end
        
        return value
    end
end

function Library:UpdateDropdown(dropdown, title, list, callback)
    if title and dropdown:FindFirstChild("DropdownHeader") then
        dropdown.DropdownHeader.Title.Text = title
    end
    
    for _, page in pairs(self.Pages) do
        for _, section in pairs(page.Sections) do
            if section.Dropdowns and section.Dropdowns[dropdown] then
                local data = section.Dropdowns[dropdown]
                
                if list then
                    data.CurrentList = list
                end
                
                if callback then
                    data.CurrentCallback = callback
                end
                
                if data.IsOpen then
                end
                
                return true
            end
        end
    end
    
    return false
end

function Library:SetDropdownList(dropdown, newList)
    for _, page in pairs(self.Pages) do
        for _, section in pairs(page.Sections) do
            if section.Dropdowns and section.Dropdowns[dropdown] then
                section.Dropdowns[dropdown].CurrentList = newList
                return true
            end
        end
    end
    return false
end

function Library:FindSectionForKeybind(keybind)
    for _, page in pairs(self.Pages) do
        for _, section in pairs(page.Sections) do
            if section.Binds and section.Binds[keybind] then
                return section
            end
        end
    end
    return nil
end

function Library:PageResize(page)
    if not page or not page.UIListLayout then
        return
    end
    local totalHeight = 0
    for _, section in ipairs(page.Sections) do
        local sectionHeight = section.Container.Parent.AbsoluteSize.Y
        totalHeight = totalHeight + sectionHeight + page.UIListLayout.Padding.Offset
    end
    page.Container.CanvasSize = UDim2.new(0, 0, 0, totalHeight + 20)
end

function Library:AnimateGradientRotation(gradient)
    task.spawn(function()
        local rotation = -180
        local step = 1
        local maxRotation = 180
        while true do
            if gradient and gradient.Parent then
                gradient.Rotation = rotation
                rotation = rotation + step
                if rotation > maxRotation then
                    rotation = -180
                end
                task.wait(0.01)
            else
                break
            end
        end
    end)
end

return Library
