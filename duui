local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local TextService = game:GetService("TextService")

local DefaultTweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

local Themes = {
    Background = Color3.fromRGB(20, 20, 20),
    DarkBackground = Color3.fromRGB(15, 15, 15),
    LightContrast = Color3.fromRGB(35, 35, 35),
    DarkContrast = Color3.fromRGB(25, 25, 25),
    Selected = Color3.fromRGB(35, 35, 35),
    TextColor = Color3.fromRGB(220, 220, 220),
    Accent = Color3.fromRGB(255, 100, 50),
    CloseButton = Color3.fromRGB(255, 60, 60),
    MinimizeButton = Color3.fromRGB(255, 180, 40)
}

local DefaultUISize = UDim2.new(0, 800, 0, 500)

local Utility = {}

function Utility:Create(className, properties, children)
    local instance = Instance.new(className)
    for property, value in pairs(properties or {}) do
        instance[property] = value
    end
    for _, child in pairs(children or {}) do
        child.Parent = instance
    end
    return instance
end

function Utility:Tween(instance, properties, duration, easingStyle, easingDirection)
    local tweenInfo = TweenInfo.new(duration or 0.2, easingStyle or Enum.EasingStyle.Quad, easingDirection or Enum.EasingDirection.Out)
    TweenService:Create(instance, tweenInfo, properties):Play()
end

function Utility:EnableDragging(frame, target)
    target = target or frame
    local dragging = false
    local dragInput, mousePos, framePos
    
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            mousePos = input.Position
            framePos = target.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - mousePos
            target.Position = UDim2.new(
                framePos.X.Scale, framePos.X.Offset + delta.X,
                framePos.Y.Scale, framePos.Y.Offset + delta.Y
            )
        end
    end)
end

local Library = {}
Library.__index = Library

function Library.New(title, version)
    local container = Utility:Create("ScreenGui", {
        Name = title or "Z3XHub",
        Parent = game.CoreGui,
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Global
    })
    
    -- Main Window
    local mainFrame = Utility:Create("Frame", {
        Name = "MainFrame",
        Position = UDim2.new(0.5, -400, 0.5, -250),
        Size = DefaultUISize,
        BackgroundColor3 = Themes.Background,
        BorderSizePixel = 0,
        ClipsDescendants = true
    }, {
        Utility:Create("UICorner", {CornerRadius = UDim.new(0, 6)}),
        Utility:Create("UIStroke", {
            Color = Themes.DarkContrast,
            Thickness = 1,
            Transparency = 0.5
        })
    })
    
    -- Top Bar
    local topBar = Utility:Create("Frame", {
        Name = "TopBar",
        Size = UDim2.new(1, 0, 0, 80),
        BackgroundColor3 = Themes.DarkBackground,
        BorderSizePixel = 0
    }, {
        -- Close and Minimize Buttons
        Utility:Create("Frame", {
            Name = "WindowControls",
            Position = UDim2.new(0, 10, 0, 10),
            Size = UDim2.new(0, 40, 0, 20),
            BackgroundTransparency = 1
        }, {
            Utility:Create("UIListLayout", {
                FillDirection = Enum.FillDirection.Horizontal,
                Padding = UDim.new(0, 5),
                SortOrder = Enum.SortOrder.LayoutOrder
            }),
            -- Minimize Button (Yellow)
            Utility:Create("TextButton", {
                Name = "MinimizeButton",
                Size = UDim2.new(0, 10, 0, 10),
                BackgroundColor3 = Themes.MinimizeButton,
                BorderSizePixel = 0,
                Text = "",
                AutoButtonColor = false,
                LayoutOrder = 1
            }, {
                Utility:Create("UICorner", {CornerRadius = UDim.new(1, 0)}),
                Utility:Create("UIStroke", {
                    Color = Color3.fromRGB(200, 140, 30),
                    Thickness = 1
                })
            }),
            -- Close Button (Red)
            Utility:Create("TextButton", {
                Name = "CloseButton",
                Size = UDim2.new(0, 10, 0, 10),
                BackgroundColor3 = Themes.CloseButton,
                BorderSizePixel = 0,
                Text = "",
                AutoButtonColor = false,
                LayoutOrder = 2
            }, {
                Utility:Create("UICorner", {CornerRadius = UDim.new(1, 0)}),
                Utility:Create("UIStroke", {
                    Color = Color3.fromRGB(200, 40, 40),
                    Thickness = 1
                })
            })
        }),
        
        -- First Separator Line
        Utility:Create("Frame", {
            Name = "Separator1",
            Position = UDim2.new(0, 10, 0, 35),
            Size = UDim2.new(1, -20, 0, 1),
            BackgroundColor3 = Themes.DarkContrast,
            BorderSizePixel = 0
        }),
        
        -- Title and Version
        Utility:Create("TextLabel", {
            Name = "TitleLabel",
            Position = UDim2.new(0, 10, 0, 40),
            Size = UDim2.new(1, -20, 0, 24),
            BackgroundTransparency = 1,
            Text = title or "Z3XHub",
            TextColor3 = Themes.TextColor,
            Font = Enum.Font.GothamBold,
            TextSize = 18,
            TextXAlignment = Enum.TextXAlignment.Left
        }),
        
        Utility:Create("TextLabel", {
            Name = "VersionLabel",
            Position = UDim2.new(0, 10, 0, 60),
            Size = UDim2.new(1, -20, 0, 16),
            BackgroundTransparency = 1,
            Text = version or "Version 6.0a",
            TextColor3 = Color3.fromRGB(150, 150, 150),
            Font = Enum.Font.Gotham,
            TextSize = 12,
            TextXAlignment = Enum.TextXAlignment.Left
        }),
        
        -- Second Separator Line
        Utility:Create("Frame", {
            Name = "Separator2",
            Position = UDim2.new(0, 10, 0, 80),
            Size = UDim2.new(1, -20, 0, 1),
            BackgroundColor3 = Themes.DarkContrast,
            BorderSizePixel = 0
        })
    })
    
    -- Sidebar for Sections
    local sidebar = Utility:Create("Frame", {
        Name = "Sidebar",
        Position = UDim2.new(0, 0, 0, 80),
        Size = UDim2.new(0, 200, 1, -80),
        BackgroundColor3 = Themes.DarkBackground,
        BorderSizePixel = 0
    }, {
        Utility:Create("ScrollingFrame", {
            Name = "SectionsContainer",
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            ScrollBarThickness = 2,
            ScrollBarImageColor3 = Themes.DarkContrast,
            CanvasSize = UDim2.new(0, 0, 0, 0)
        }, {
            Utility:Create("UIListLayout", {
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, 5)
            }),
            Utility:Create("UIPadding", {
                PaddingTop = UDim.new(0, 10),
                PaddingLeft = UDim.new(0, 10),
                PaddingRight = UDim.new(0, 10)
            })
        })
    })
    
    -- Content Area
    local contentArea = Utility:Create("Frame", {
        Name = "ContentArea",
        Position = UDim2.new(0, 200, 0, 80),
        Size = UDim2.new(1, -200, 1, -80),
        BackgroundColor3 = Themes.Background,
        BorderSizePixel = 0
    }, {
        Utility:Create("Frame", {
            Name = "PageContainer",
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            ClipsDescendants = true
        })
    })
    
    -- Add all frames to main container
    topBar.Parent = mainFrame
    sidebar.Parent = mainFrame
    contentArea.Parent = mainFrame
    mainFrame.Parent = container
    
    -- Enable dragging from top bar
    Utility:EnableDragging(topBar, mainFrame)
    
    local lib = setmetatable({
        Container = container,
        MainFrame = mainFrame,
        Sidebar = sidebar.SectionsContainer,
        ContentArea = contentArea.PageContainer,
        Pages = {},
        SelectedPage = nil,
        IsMinimized = false
    }, Library)
    
    -- Setup close button
    topBar.WindowControls.CloseButton.MouseButton1Click:Connect(function()
        container:Destroy()
    end)
    
    topBar.WindowControls.CloseButton.MouseEnter:Connect(function()
        Utility:Tween(topBar.WindowControls.CloseButton, {Size = UDim2.new(0, 12, 0, 12)}, 0.1)
    end)
    
    topBar.WindowControls.CloseButton.MouseLeave:Connect(function()
        Utility:Tween(topBar.WindowControls.CloseButton, {Size = UDim2.new(0, 10, 0, 10)}, 0.1)
    end)
    
    -- Setup minimize button
    topBar.WindowControls.MinimizeButton.MouseButton1Click:Connect(function()
        lib:ToggleMinimize()
    end)
    
    topBar.WindowControls.MinimizeButton.MouseEnter:Connect(function()
        Utility:Tween(topBar.WindowControls.MinimizeButton, {Size = UDim2.new(0, 12, 0, 12)}, 0.1)
    end)
    
    topBar.WindowControls.MinimizeButton.MouseLeave:Connect(function()
        Utility:Tween(topBar.WindowControls.MinimizeButton, {Size = UDim2.new(0, 10, 0, 10)}, 0.1)
    end)
    
    return lib
end

function Library:ToggleMinimize()
    if self.IsMinimized then
        -- Restore
        Utility:Tween(self.MainFrame, {
            Size = DefaultUISize,
            Position = UDim2.new(0.5, -400, 0.5, -250)
        }, 0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
    else
        -- Minimize to top
        Utility:Tween(self.MainFrame, {
            Size = UDim2.new(0, 800, 0, 80),
            Position = UDim2.new(0.5, -400, 0, 50)
        }, 0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
    end
    self.IsMinimized = not self.IsMinimized
end

function Library:AddPage(title, icon)
    local page = self:CreatePage(title, icon)
    table.insert(self.Pages, page)
    
    -- Select first page by default
    if #self.Pages == 1 then
        self:SelectPage(page)
    end
    
    return page
end

function Library:CreatePage(title, icon)
    -- Create section button in sidebar
    local sectionButton = Utility:Create("TextButton", {
        Name = title,
        Size = UDim2.new(1, 0, 0, 40),
        BackgroundColor3 = Themes.DarkBackground,
        BorderSizePixel = 0,
        Text = "",
        AutoButtonColor = false
    }, {
        Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
        
        -- Selection indicator (hidden by default)
        Utility:Create("Frame", {
            Name = "SelectionIndicator",
            Position = UDim2.new(0, -10, 0, 0),
            Size = UDim2.new(0, 3, 1, 0),
            BackgroundColor3 = Themes.Accent,
            BorderSizePixel = 0,
            BackgroundTransparency = 1
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 2)})
        }),
        
        -- Text label
        Utility:Create("TextLabel", {
            Name = "Title",
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = title,
            TextColor3 = Color3.fromRGB(180, 180, 180),
            Font = Enum.Font.Gotham,
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Left
        }, {
            Utility:Create("UIPadding", {
                PaddingLeft = UDim.new(0, 15)
            })
        })
    })
    
    -- Create page container
    local pageContainer = Utility:Create("ScrollingFrame", {
        Name = title .. "Page",
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        ScrollBarThickness = 3,
        ScrollBarImageColor3 = Themes.DarkContrast,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        Visible = false
    }, {
        Utility:Create("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 10)
        }),
        Utility:Create("UIPadding", {
            PaddingTop = UDim.new(0, 10),
            PaddingLeft = UDim.new(0, 10),
            PaddingRight = UDim.new(0, 10)
        })
    })
    
    sectionButton.Parent = self.Sidebar
    pageContainer.Parent = self.ContentArea
    
    -- Update scrolling frame size
    local updateListSize = function()
        if pageContainer:FindFirstChildOfClass("UIListLayout") then
            local contentSize = pageContainer:FindFirstChildOfClass("UIListLayout").AbsoluteContentSize
            pageContainer.CanvasSize = UDim2.new(0, 0, 0, contentSize.Y + 20)
        end
    end
    
    if pageContainer:FindFirstChildOfClass("UIListLayout") then
        pageContainer:FindFirstChildOfClass("UIListLayout"):GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateListSize)
    end
    
    -- Button click event
    sectionButton.MouseButton1Click:Connect(function()
        self:SelectPage(page)
    end)
    
    -- Hover effects
    sectionButton.MouseEnter:Connect(function()
        if self.SelectedPage ~= page then
            Utility:Tween(sectionButton, {BackgroundColor3 = Themes.LightContrast}, 0.2)
        end
    end)
    
    sectionButton.MouseLeave:Connect(function()
        if self.SelectedPage ~= page then
            Utility:Tween(sectionButton, {BackgroundColor3 = Themes.DarkBackground}, 0.2)
        end
    end)
    
    local pageObj = {
        Button = sectionButton,
        Container = pageContainer,
        Title = title,
        Sections = {}
    }
    
    -- Add section methods
    pageObj.addSection = function(selfSection, title)
        return Library:AddSection(pageObj, title)
    end
    
    pageObj.addButton = function(selfSection, title, callback)
        return Library:AddButton(pageObj, title, callback)
    end
    
    pageObj.addToggle = function(selfSection, title, default, callback)
        return Library:AddToggle(pageObj, title, default, callback)
    end
    
    pageObj.addLabel = function(selfSection, title)
        return Library:AddLabel(pageObj, title)
    end
    
    pageObj.addSlider = function(selfSection, title, min, max, default, callback)
        return Library:AddSlider(pageObj, title, min, max, default, callback)
    end
    
    pageObj.addDropdown = function(selfSection, title, options, callback)
        return Library:AddDropdown(pageObj, title, options, callback)
    end
    
    return pageObj
end

function Library:SelectPage(page)
    if self.SelectedPage then
        -- Deselect previous page
        self.SelectedPage.Container.Visible = false
        Utility:Tween(self.SelectedPage.Button, {
            BackgroundColor3 = Themes.DarkBackground
        }, 0.2)
        Utility:Tween(self.SelectedPage.Button.Title, {
            TextColor3 = Color3.fromRGB(180, 180, 180)
        }, 0.2)
        Utility:Tween(self.SelectedPage.Button.SelectionIndicator, {
            BackgroundTransparency = 1
        }, 0.2)
    end
    
    -- Select new page
    page.Container.Visible = true
    Utility:Tween(page.Button, {
        BackgroundColor3 = Themes.Selected
    }, 0.2)
    Utility:Tween(page.Button.Title, {
        TextColor3 = Themes.TextColor
    }, 0.2)
    Utility:Tween(page.Button.SelectionIndicator, {
        BackgroundTransparency = 0
    }, 0.2)
    
    self.SelectedPage = page
end

-- Section functions
function Library:AddSection(page, title)
    local section = Utility:Create("Frame", {
        Name = title,
        Size = UDim2.new(1, 0, 0, 40),
        BackgroundColor3 = Themes.DarkContrast,
        BorderSizePixel = 0
    }, {
        Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
        
        Utility:Create("TextLabel", {
            Name = "Title",
            Position = UDim2.new(0, 10, 0, 0),
            Size = UDim2.new(1, -10, 1, 0),
            BackgroundTransparency = 1,
            Text = title,
            TextColor3 = Themes.TextColor,
            Font = Enum.Font.GothamBold,
            TextSize = 16,
            TextXAlignment = Enum.TextXAlignment.Left
        }),
        
        Utility:Create("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 8)
        }),
        
        Utility:Create("UIPadding", {
            PaddingTop = UDim.new(0, 40),
            PaddingLeft = UDim.new(0, 10),
            PaddingRight = UDim.new(0, 10),
            PaddingBottom = UDim.new(0, 10)
        })
    })
    
    section.Parent = page.Container
    
    local sectionObj = {
        Frame = section,
        addButton = function(selfBtn, title, callback)
            return Library:AddButton(page, title, callback, section)
        end,
        addToggle = function(selfToggle, title, default, callback)
            return Library:AddToggle(page, title, default, callback, section)
        end,
        addLabel = function(selfLabel, title)
            return Library:AddLabel(page, title, section)
        end,
        addSlider = function(selfSlider, title, min, max, default, callback)
            return Library:AddSlider(page, title, min, max, default, callback, section)
        end,
        addDropdown = function(selfDropdown, title, options, callback)
            return Library:AddDropdown(page, title, options, callback, section)
        end
    }
    
    table.insert(page.Sections, sectionObj)
    return sectionObj
end

function Library:AddButton(page, title, callback, section)
    local button = Utility:Create("TextButton", {
        Name = title,
        Size = UDim2.new(1, 0, 0, 35),
        BackgroundColor3 = Themes.LightContrast,
        BorderSizePixel = 0,
        Text = "",
        AutoButtonColor = false
    }, {
        Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
        
        Utility:Create("TextLabel", {
            Name = "Title",
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = title,
            TextColor3 = Themes.TextColor,
            Font = Enum.Font.Gotham,
            TextSize = 14
        }),
        
        Utility:Create("UIStroke", {
            Color = Themes.DarkContrast,
            Thickness = 1
        })
    })
    
    -- Hover effects
    button.MouseEnter:Connect(function()
        Utility:Tween(button, {BackgroundColor3 = Themes.Accent}, 0.2)
    end)
    
    button.MouseLeave:Connect(function()
        Utility:Tween(button, {BackgroundColor3 = Themes.LightContrast}, 0.2)
    end)
    
    -- Click event
    button.MouseButton1Click:Connect(function()
        if callback then
            pcall(callback)
        end
    end)
    
    if section then
        button.Parent = section.Frame
    else
        button.Parent = page.Container
    end
    
    return button
end

function Library:AddToggle(page, title, default, callback, section)
    local toggleState = default or false
    
    local toggle = Utility:Create("Frame", {
        Name = title,
        Size = UDim2.new(1, 0, 0, 35),
        BackgroundTransparency = 1
    }, {
        Utility:Create("UIListLayout", {
            FillDirection = Enum.FillDirection.Horizontal,
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 10)
        }),
        
        -- Toggle switch
        Utility:Create("TextButton", {
            Name = "ToggleButton",
            Size = UDim2.new(0, 60, 0, 25),
            BackgroundColor3 = toggleState and Themes.Accent or Themes.LightContrast,
            BorderSizePixel = 0,
            Text = "",
            AutoButtonColor = false
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 12)}),
            
            Utility:Create("Frame", {
                Name = "ToggleCircle",
                AnchorPoint = Vector2.new(0.5, 0.5),
                Position = toggleState and UDim2.new(0.75, 0, 0.5, 0) or UDim2.new(0.25, 0, 0.5, 0),
                Size = UDim2.new(0, 18, 0, 18),
                BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                BorderSizePixel = 0
            }, {
                Utility:Create("UICorner", {CornerRadius = UDim.new(1, 0)})
            })
        }),
        
        -- Label
        Utility:Create("TextLabel", {
            Name = "Title",
            Size = UDim2.new(1, -70, 1, 0),
            BackgroundTransparency = 1,
            Text = title,
            TextColor3 = Themes.TextColor,
            Font = Enum.Font.Gotham,
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Left
        })
    })
    
    local toggleButton = toggle.ToggleButton
    local toggleCircle = toggleButton.ToggleCircle
    
    -- Toggle click event
    toggleButton.MouseButton1Click:Connect(function()
        toggleState = not toggleState
        
        if toggleState then
            Utility:Tween(toggleButton, {BackgroundColor3 = Themes.Accent}, 0.2)
            Utility:Tween(toggleCircle, {Position = UDim2.new(0.75, 0, 0.5, 0)}, 0.2)
        else
            Utility:Tween(toggleButton, {BackgroundColor3 = Themes.LightContrast}, 0.2)
            Utility:Tween(toggleCircle, {Position = UDim2.new(0.25, 0, 0.5, 0)}, 0.2)
        end
        
        if callback then
            pcall(callback, toggleState)
        end
    end)
    
    if section then
        toggle.Parent = section.Frame
    else
        toggle.Parent = page.Container
    end
    
    return {
        Set = function(state)
            toggleState = state
            if state then
                Utility:Tween(toggleButton, {BackgroundColor3 = Themes.Accent}, 0.2)
                Utility:Tween(toggleCircle, {Position = UDim2.new(0.75, 0, 0.5, 0)}, 0.2)
            else
                Utility:Tween(toggleButton, {BackgroundColor3 = Themes.LightContrast}, 0.2)
                Utility:Tween(toggleCircle, {Position = UDim2.new(0.25, 0, 0.5, 0)}, 0.2)
            end
        end,
        Get = function()
            return toggleState
        end
    }
end

function Library:AddLabel(page, title, section)
    local label = Utility:Create("TextLabel", {
        Name = "Label",
        Size = UDim2.new(1, 0, 0, 25),
        BackgroundTransparency = 1,
        Text = title,
        TextColor3 = Themes.TextColor,
        Font = Enum.Font.Gotham,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    if section then
        label.Parent = section.Frame
    else
        label.Parent = page.Container
    end
    
    return label
end

function Library:AddSlider(page, title, min, max, default, callback, section)
    local value = default or min
    
    local slider = Utility:Create("Frame", {
        Name = title,
        Size = UDim2.new(1, 0, 0, 60),
        BackgroundTransparency = 1
    }, {
        -- Title
        Utility:Create("TextLabel", {
            Name = "Title",
            Size = UDim2.new(1, 0, 0, 20),
            BackgroundTransparency = 1,
            Text = title .. ": " .. tostring(value),
            TextColor3 = Themes.TextColor,
            Font = Enum.Font.Gotham,
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Left
        }),
        
        -- Slider track
        Utility:Create("Frame", {
            Name = "SliderTrack",
            Position = UDim2.new(0, 0, 0, 30),
            Size = UDim2.new(1, 0, 0, 6),
            BackgroundColor3 = Themes.LightContrast,
            BorderSizePixel = 0
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 3)}),
            
            -- Slider fill
            Utility:Create("Frame", {
                Name = "SliderFill",
                Size = UDim2.new((value - min) / (max - min), 0, 1, 0),
                BackgroundColor3 = Themes.Accent,
                BorderSizePixel = 0
            }, {
                Utility:Create("UICorner", {CornerRadius = UDim.new(0, 3)})
            }),
            
            -- Slider thumb
            Utility:Create("Frame", {
                Name = "SliderThumb",
                AnchorPoint = Vector2.new(0.5, 0.5),
                Position = UDim2.new((value - min) / (max - min), 0, 0.5, 0),
                Size = UDim2.new(0, 14, 0, 14),
                BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                BorderSizePixel = 0
            }, {
                Utility:Create("UICorner", {CornerRadius = UDim.new(1, 0)}),
                Utility:Create("UIStroke", {
                    Color = Themes.Accent,
                    Thickness = 2
                })
            })
        })
    })
    
    local sliderTrack = slider.SliderTrack
    local sliderFill = sliderTrack.SliderFill
    local sliderThumb = sliderTrack.SliderThumb
    local titleLabel = slider.Title
    
    local isDragging = false
    
    local function updateSlider(input)
        local x = math.clamp((input.Position.X - sliderTrack.AbsolutePosition.X) / sliderTrack.AbsoluteSize.X, 0, 1)
        value = math.floor(min + (max - min) * x + 0.5)
        
        sliderFill.Size = UDim2.new(x, 0, 1, 0)
        sliderThumb.Position = UDim2.new(x, 0, 0.5, 0)
        titleLabel.Text = title .. ": " .. tostring(value)
        
        if callback then
            pcall(callback, value)
        end
    end
    
    sliderTrack.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = true
            updateSlider(input)
        end
    end)
    
    sliderTrack.InputChanged:Connect(function(input)
        if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            updateSlider(input)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = false
        end
    end)
    
    if section then
        slider.Parent = section.Frame
    else
        slider.Parent = page.Container
    end
    
    return {
        Set = function(newValue)
            value = math.clamp(newValue, min, max)
            local x = (value - min) / (max - min)
            sliderFill.Size = UDim2.new(x, 0, 1, 0)
            sliderThumb.Position = UDim2.new(x, 0, 0.5, 0)
            titleLabel.Text = title .. ": " .. tostring(value)
        end,
        Get = function()
            return value
        end
    }
end

function Library:AddDropdown(page, title, options, callback, section)
    local isOpen = false
    local selected = options[1] or "Select..."
    
    local dropdown = Utility:Create("Frame", {
        Name = title,
        Size = UDim2.new(1, 0, 0, 35),
        BackgroundTransparency = 1,
        ClipsDescendants = true
    }, {
        -- Dropdown button
        Utility:Create("TextButton", {
            Name = "DropdownButton",
            Size = UDim2.new(1, 0, 0, 35),
            BackgroundColor3 = Themes.LightContrast,
            BorderSizePixel = 0,
            Text = "",
            AutoButtonColor = false
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            
            Utility:Create("TextLabel", {
                Name = "Title",
                Position = UDim2.new(0, 10, 0, 0),
                Size = UDim2.new(1, -30, 1, 0),
                BackgroundTransparency = 1,
                Text = selected,
                TextColor3 = Themes.TextColor,
                Font = Enum.Font.Gotham,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            }),
            
            -- Arrow icon
            Utility:Create("ImageLabel", {
                Name = "Arrow",
                AnchorPoint = Vector2.new(0.5, 0.5),
                Position = UDim2.new(1, -15, 0.5, 0),
                Size = UDim2.new(0, 12, 0, 12),
                BackgroundTransparency = 1,
                Image = "rbxassetid://6031091004",
                ImageColor3 = Themes.TextColor,
                Rotation = 0
            })
        }),
        
        -- Options container
        Utility:Create("Frame", {
            Name = "OptionsContainer",
            Position = UDim2.new(0, 0, 0, 40),
            Size = UDim2.new(1, 0, 0, 0),
            BackgroundColor3 = Themes.DarkContrast,
            BorderSizePixel = 0,
            Visible = false
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            Utility:Create("UIStroke", {
                Color = Themes.LightContrast,
                Thickness = 1
            }),
            
            Utility:Create("ScrollingFrame", {
                Name = "OptionsList",
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                BorderSizePixel = 0,
                ScrollBarThickness = 2,
                CanvasSize = UDim2.new(0, 0, 0, 0)
            }, {
                Utility:Create("UIListLayout", {
                    SortOrder = Enum.SortOrder.LayoutOrder,
                    Padding = UDim.new(0, 2)
                }),
                Utility:Create("UIPadding", {
                    PaddingTop = UDim.new(0, 5),
                    PaddingLeft = UDim.new(0, 5),
                    PaddingRight = UDim.new(0, 5),
                    PaddingBottom = UDim.new(0, 5)
                })
            })
        })
    })
    
    local dropdownButton = dropdown.DropdownButton
    local optionsContainer = dropdown.OptionsContainer
    local optionsList = optionsContainer.OptionsList
    local arrow = dropdownButton.Arrow
    
    local function toggleDropdown()
        isOpen = not isOpen
        
        if isOpen then
            optionsContainer.Visible = true
            Utility:Tween(optionsContainer, {Size = UDim2.new(1, 0, 0, math.min(#options * 30 + 10, 150))}, 0.2)
            Utility:Tween(arrow, {Rotation = 180}, 0.2)
        else
            Utility:Tween(optionsContainer, {Size = UDim2.new(1, 0, 0, 0)}, 0.2)
            Utility:Tween(arrow, {Rotation = 0}, 0.2)
            wait(0.2)
            optionsContainer.Visible = false
        end
    end
    
    dropdownButton.MouseButton1Click:Connect(toggleDropdown)
    
    -- Create option buttons
    for i, option in ipairs(options) do
        local optionButton = Utility:Create("TextButton", {
            Name = option,
            Size = UDim2.new(1, 0, 0, 30),
            BackgroundColor3 = Themes.LightContrast,
            BorderSizePixel = 0,
            Text = "",
            AutoButtonColor = false
        }, {
            Utility:Create("UICorner", {CornerRadius = UDim.new(0, 4)}),
            
            Utility:Create("TextLabel", {
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = option,
                TextColor3 = Themes.TextColor,
                Font = Enum.Font.Gotham,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            }, {
                Utility:Create("UIPadding", {
                    PaddingLeft = UDim.new(0, 10)
                })
            })
        })
        
        optionButton.MouseEnter:Connect(function()
            Utility:Tween(optionButton, {BackgroundColor3 = Themes.Accent}, 0.2)
        end)
        
        optionButton.MouseLeave:Connect(function()
            Utility:Tween(optionButton, {BackgroundColor3 = Themes.LightContrast}, 0.2)
        end)
        
        optionButton.MouseButton1Click:Connect(function()
            selected = option
            dropdownButton.Title.Text = selected
            toggleDropdown()
            
            if callback then
                pcall(callback, selected)
            end
        end)
        
        optionButton.Parent = optionsList
    end
    
    -- Update options list size
    optionsList.CanvasSize = UDim2.new(0, 0, 0, #options * 32)
    
    if section then
        dropdown.Parent = section.Frame
    else
        dropdown.Parent = page.Container
    end
    
    return {
        Set = function(option)
            if table.find(options, option) then
                selected = option
                dropdownButton.Title.Text = selected
            end
        end,
        Get = function()
            return selected
        end
    }
end

return Library
