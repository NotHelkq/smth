-- Assuming this is executed in a Roblox environment via an executor.
-- We'll use Roblox's built-in UI elements. If you have a specific UI library like Rayfield or something else,
-- let me know for adjustments. Here, "Utility:Create" is implemented as a simple wrapper for Instance.new with properties.

local Utility = {}

function Utility:Create(className, properties)
    local instance = Instance.new(className)
    for key, value in pairs(properties or {}) do
        if key ~= "Parent" then
            instance[key] = value
        end
    end
    if properties and properties.Parent then
        instance.Parent = properties.Parent
    end
    return instance
end

-- Colors
local menuColor = Color3.fromRGB(15, 15, 15) -- #0F0F0F
local sectionColor = Color3.fromRGB(20, 20, 20) -- #141414
local textColor = Color3.fromRGB(96, 96, 96) -- #606060
local selectedTextColor = Color3.fromRGB(200, 200, 200) -- #C8C8C8
local selectedSectionColor = Color3.fromRGB(20, 20, 20) -- #141414
local closeButtonColor = Color3.fromRGB(254, 92, 103) -- #FE5C67
local minimizeButtonColor = Color3.fromRGB(241, 194, 50) -- #F1C232
local lineColor = Color3.fromRGB(37, 37, 37) -- #252525
local displayNameColor = Color3.fromRGB(206, 206, 206) -- #CECECE
local usernameColor = Color3.fromRGB(80, 80, 80) -- #505050

-- Get player info
local player = game.Players.LocalPlayer
local userId = player.UserId
local displayName = player.DisplayName
local username = player.Name

-- UI Title and Version
local uiTitle = getgenv().UITitle or "Unknown UI v2" -- Assume external script sets getgenv().UITitle
local uiVersion = getgenv().UIVersion or "1.0" -- Assume external sets version

-- Create ScreenGui
local screenGui = Utility:Create("ScreenGui", {
    Parent = game.CoreGui, -- For executor access
    IgnoreGuiInset = true,
    ResetOnSpawn = false
})

-- Main Frame (Resizable)
local mainFrame = Utility:Create("Frame", {
    Parent = screenGui,
    BackgroundColor3 = menuColor,
    Size = UDim2.new(0, 600, 0, 400),
    Position = UDim2.new(0.5, -300, 0.5, -200),
    Active = true,
    Draggable = true,
    BorderSizePixel = 0
})

-- Make resizable
local resizeButton = Utility:Create("TextButton", {
    Parent = mainFrame,
    BackgroundColor3 = Color3.fromRGB(255, 255, 255),
    BackgroundTransparency = 1,
    Size = UDim2.new(0, 20, 0, 20),
    Position = UDim2.new(1, -20, 1, -20),
    Text = ""
})
local resizing = false
resizeButton.MouseButton1Down:Connect(function()
    resizing = true
end)
game:GetService("UserInputService").InputChanged:Connect(function(input)
    if resizing and input.UserInputType == Enum.UserInputType.MouseMovement then
        local mousePos = input.Position
        local absPos = mainFrame.AbsolutePosition
        mainFrame.Size = UDim2.new(0, mousePos.X - absPos.X, 0, mousePos.Y - absPos.Y)
    end
end)
resizeButton.MouseButton1Up:Connect(function()
    resizing = false
end)

-- UIGradient for mainFrame (animated)
local uiGradient = Utility:Create("UIGradient", {
    Parent = mainFrame,
    Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0.00, Color3.fromRGB(255, 200, 0)),
        ColorSequenceKeypoint.new(0.07, Color3.fromRGB(255, 180, 0)),
        ColorSequenceKeypoint.new(0.14, Color3.fromRGB(255, 160, 0)),
        ColorSequenceKeypoint.new(0.21, Color3.fromRGB(255, 140, 0)),
        ColorSequenceKeypoint.new(0.28, Color3.fromRGB(255, 120, 0)),
        ColorSequenceKeypoint.new(0.35, Color3.fromRGB(255, 100, 0)),
        ColorSequenceKeypoint.new(0.42, Color3.fromRGB(255, 80, 0)),
        ColorSequenceKeypoint.new(0.49, Color3.fromRGB(255, 60, 0)),
        ColorSequenceKeypoint.new(0.56, Color3.fromRGB(255, 40, 0)),
        ColorSequenceKeypoint.new(0.63, Color3.fromRGB(255, 20, 0)),
        ColorSequenceKeypoint.new(0.70, Color3.fromRGB(255, 0, 0)),
        ColorSequenceKeypoint.new(0.77, Color3.fromRGB(255, 40, 0)),
        ColorSequenceKeypoint.new(0.84, Color3.fromRGB(255, 80, 0)),
        ColorSequenceKeypoint.new(0.91, Color3.fromRGB(255, 120, 0)),
        ColorSequenceKeypoint.new(0.98, Color3.fromRGB(255, 160, 0)),
        ColorSequenceKeypoint.new(1.00, Color3.fromRGB(255, 200, 0))
    }),
    Rotation = -180
})

-- Animate gradient
spawn(function()
    while true do
        for i = -180, 180, 1 do
            uiGradient.Rotation = i
            wait(0.05) -- Adjust speed
        end
        uiGradient.Rotation = -179
    end
end)

-- Top buttons: Close and Minimize (circles)
local topBar = Utility:Create("Frame", {
    Parent = mainFrame,
    BackgroundTransparency = 1,
    Size = UDim2.new(1, 0, 0, 30),
    Position = UDim2.new(0, 0, 0, 0)
})

local closeButton = Utility:Create("Frame", {
    Parent = topBar,
    BackgroundColor3 = closeButtonColor,
    Size = UDim2.new(0, 15, 0, 15),
    Position = UDim2.new(0, 5, 0.5, -7.5),
    BorderSizePixel = 0
})
Utility:Create("UICorner", {Parent = closeButton, CornerRadius = UDim.new(1, 0)})
closeButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        screenGui:Destroy()
    end
end)

local minimizeButton = Utility:Create("Frame", {
    Parent = topBar,
    BackgroundColor3 = minimizeButtonColor,
    Size = UDim2.new(0, 15, 0, 15),
    Position = UDim2.new(0, 25, 0.5, -7.5),
    BorderSizePixel = 0
})
Utility:Create("UICorner", {Parent = minimizeButton, CornerRadius = UDim.new(1, 0)})
minimizeButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        mainFrame.Visible = not mainFrame.Visible
    end
end)

-- Line under buttons
local line1 = Utility:Create("Frame", {
    Parent = mainFrame,
    BackgroundColor3 = lineColor,
    Size = UDim2.new(1, 0, 0, 1),
    Position = UDim2.new(0, 0, 0, 30),
    BorderSizePixel = 0
})

-- Title
local titleLabel = Utility:Create("TextLabel", {
    Parent = mainFrame,
    BackgroundTransparency = 1,
    Size = UDim2.new(1, 0, 0, 30),
    Position = UDim2.new(0, 0, 0, 31),
    Text = uiTitle,
    TextColor3 = Color3.fromRGB(255, 255, 255),
    Font = Enum.Font.SourceSansBold,
    TextSize = 18,
    TextXAlignment = Enum.TextXAlignment.Center
})

-- Version
local versionLabel = Utility:Create("TextLabel", {
    Parent = mainFrame,
    BackgroundTransparency = 1,
    Size = UDim2.new(1, 0, 0, 20),
    Position = UDim2.new(0, 0, 0, 61),
    Text = "version: " .. uiVersion,
    TextColor3 = textColor,
    Font = Enum.Font.SourceSans,
    TextSize = 14,
    TextXAlignment = Enum.TextXAlignment.Center
})

-- Line under title/version
local line2 = Utility:Create("Frame", {
    Parent = mainFrame,
    BackgroundColor3 = lineColor,
    Size = UDim2.new(1, 0, 0, 1),
    Position = UDim2.new(0, 0, 0, 81),
    BorderSizePixel = 0
})

-- Sidebar for sections (tabs)
local sidebar = Utility:Create("Frame", {
    Parent = mainFrame,
    BackgroundTransparency = 1,
    Size = UDim2.new(0, 150, 1, -112),
    Position = UDim2.new(0, 0, 0, 82)
})

local sidebarList = Utility:Create("UIListLayout", {
    Parent = sidebar,
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 5)
})

-- Content area for pages
local content = Utility:Create("Frame", {
    Parent = mainFrame,
    BackgroundTransparency = 1,
    Size = UDim2.new(1, -150, 1, -112),
    Position = UDim2.new(0, 150, 0, 82),
    ClipsDescendants = true
})

-- Player info bottom left
local playerFrame = Utility:Create("Frame", {
    Parent = mainFrame,
    BackgroundTransparency = 1,
    Size = UDim2.new(0, 150, 0, 50),
    Position = UDim2.new(0, 0, 1, -50)
})

local avatarImage = Utility:Create("ImageLabel", {
    Parent = playerFrame,
    BackgroundTransparency = 1,
    Size = UDim2.new(0, 40, 0, 40),
    Position = UDim2.new(0, 5, 0.5, -20),
    Image = "rbxthumb://type=AvatarHeadShot&id=" .. userId .. "&w=48&h=48"
})
Utility:Create("UICorner", {Parent = avatarImage, CornerRadius = UDim.new(1, 0)})

local displayNameLabel = Utility:Create("TextLabel", {
    Parent = playerFrame,
    BackgroundTransparency = 1,
    Size = UDim2.new(1, -50, 0, 20),
    Position = UDim2.new(0, 50, 0, 5),
    Text = displayName,
    TextColor3 = displayNameColor,
    Font = Enum.Font.SourceSansBold,
    TextSize = 14,
    TextXAlignment = Enum.TextXAlignment.Left
})

local usernameLabel = Utility:Create("TextLabel", {
    Parent = playerFrame,
    BackgroundTransparency = 1,
    Size = UDim2.new(1, -50, 0, 20),
    Position = UDim2.new(0, 50, 0, 25),
    Text = "@" .. username,
    TextColor3 = usernameColor,
    Font = Enum.Font.SourceSans,
    TextSize = 12,
    TextXAlignment = Enum.TextXAlignment.Left
})

-- Library for creating sections and elements
local UI = {}
local sections = {}
local currentPage = nil

function UI:addSection(name, decalId)
    local sectionButton = Utility:Create("TextButton", {
        Parent = sidebar,
        BackgroundColor3 = sectionColor,
        Size = UDim2.new(1, 0, 0, 30),
        Text = name,
        TextColor3 = textColor,
        Font = Enum.Font.SourceSans,
        TextSize = 14,
        AutoButtonColor = false
    })
    Utility:Create("UICorner", {Parent = sectionButton, CornerRadius = UDim.new(0, 4)})

    if decalId then
        local decal = Utility:Create("ImageLabel", {
            Parent = sectionButton,
            BackgroundTransparency = 1,
            Size = UDim2.new(0, 20, 0, 20),
            Position = UDim2.new(0, 5, 0.5, -10),
            Image = "rbxassetid://" .. decalId
        })
        sectionButton.TextXAlignment = Enum.TextXAlignment.Left
        sectionButton.TextPadding = UDim.new(0, 30)
    end

    local page = Utility:Create("ScrollingFrame", {
        Parent = content,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ScrollBarThickness = 0,
        Visible = false
    })

    -- Section name on top of page
    local pageTitle = Utility:Create("TextLabel", {
        Parent = page,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 30),
        Position = UDim2.new(0, 0, 0, 0),
        Text = name,
        TextColor3 = selectedTextColor,
        Font = Enum.Font.SourceSansBold,
        TextSize = 16,
        TextXAlignment = Enum.TextXAlignment.Left
    })

    local pageLine = Utility:Create("Frame", {
        Parent = page,
        BackgroundColor3 = lineColor,
        Size = UDim2.new(1, 0, 0, 1),
        Position = UDim2.new(0, 0, 0, 30),
        BorderSizePixel = 0
    })

    -- Grid for sub-sections (2 per row)
    local grid = Utility:Create("UIGridLayout", {
        Parent = page,
        CellSize = UDim2.new(0.48, 0, 0, 0), -- Auto height later
        CellPadding = UDim2.new(0.02, 0, 0, 10),
        SortOrder = Enum.SortOrder.LayoutOrder,
        StartCorner = Enum.StartCorner.TopLeft,
        HorizontalAlignment = Enum.HorizontalAlignment.Left,
        VerticalAlignment = Enum.VerticalAlignment.Top
    })

    page.CanvasPosition = Vector2.new(0, 0)
    page.CanvasSize = UDim2.new(0, 0, 0, 0) -- Will auto update

    sectionButton.MouseButton1Click:Connect(function()
        if currentPage then
            currentPage.Visible = false
            sections[currentPage].BackgroundColor3 = sectionColor
            sections[currentPage].TextColor3 = textColor
        end
        page.Visible = true
        sectionButton.BackgroundColor3 = selectedSectionColor
        sectionButton.TextColor3 = selectedTextColor
        currentPage = page
        sections[page] = sectionButton
    end)

    sections[page] = sectionButton -- Store for selection

    -- Default select first section
    if not currentPage then
        sectionButton:SimulateMouseClick() -- Wait, no direct, call the function
        sectionButton.MouseButton1Click:Invoke()
    end

    -- Return object for adding sub-sections/elements
    local sectionObj = {
        page = page,
        grid = grid,
        subSections = {}
    }

    function sectionObj:addSubSection(name)
        local subSection = Utility:Create("Frame", {
            Parent = page,
            BackgroundColor3 = sectionColor,
            BorderSizePixel = 0,
            LayoutOrder = #sectionObj.subSections + 1
        })
        Utility:Create("UICorner", {Parent = subSection, CornerRadius = UDim.new(0, 4)})
        Utility:Create("UIPadding", {Parent = subSection, PaddingTop = UDim.new(0, 5), PaddingBottom = UDim.new(0, 5), PaddingLeft = UDim.new(0, 5), PaddingRight = UDim.new(0, 5)})

        local subTitle = Utility:Create("TextLabel", {
            Parent = subSection,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 0, 20),
            Text = name,
            TextColor3 = textColor,
            Font = Enum.Font.SourceSans,
            TextSize = 14
        })

        local listLayout = Utility:Create("UIListLayout", {
            Parent = subSection,
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 5)
        })

        table.insert(sectionObj.subSections, subSection)

        -- Auto resize subSection and update canvas
        local function updateSize()
            local height = 20 -- Title
            for _, child in ipairs(subSection:GetChildren()) do
                if child:IsA("GuiObject") and child.Visible then
                    height = height + child.AbsoluteSize.Y + listLayout.Padding.Offset
                end
            end
            subSection.Size = UDim2.new(0.48, 0, 0, height)
            local totalHeight = 31 -- page title + line
            for _, sub in ipairs(sectionObj.subSections) do
                totalHeight = totalHeight + sub.AbsoluteSize.Y + 10 -- padding
            end
            page.CanvasSize = UDim2.new(0, 0, 0, totalHeight)
        end

        listLayout.Changed:Connect(updateSize)
        updateSize()

        -- Methods for elements
        local elements = {}

        function elements:addButton(text, callback)
            local button = Utility:Create("TextButton", {
                Parent = subSection,
                BackgroundColor3 = sectionColor,
                Size = UDim2.new(1, 0, 0, 30),
                Text = text,
                TextColor3 = textColor,
                Font = Enum.Font.SourceSans,
                TextSize = 14
            })
            Utility:Create("UICorner", {Parent = button, CornerRadius = UDim.new(0, 4)})
            button.MouseButton1Click:Connect(callback or function() end)
            updateSize()
            return button
        end

        function elements:addToggle(text, default, callback)
            local toggleFrame = Utility:Create("Frame", {
                Parent = subSection,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 0, 30)
            })

            local label = Utility:Create("TextLabel", {
                Parent = toggleFrame,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, -40, 1, 0),
                Text = text,
                TextColor3 = textColor,
                Font = Enum.Font.SourceSans,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            })

            local toggle = Utility:Create("Frame", {
                Parent = toggleFrame,
                BackgroundColor3 = default and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0),
                Size = UDim2.new(0, 30, 0, 15),
                Position = UDim2.new(1, -30, 0.5, -7.5)
            })
            Utility:Create("UICorner", {Parent = toggle, CornerRadius = UDim.new(0, 8)})

            local state = default
            toggle.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    state = not state
                    toggle.BackgroundColor3 = state and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
                    if callback then callback(state) end
                end
            end)
            updateSize()
            return elements
        end

        function elements:addSlider(text, min, max, default, callback)
            local sliderFrame = Utility:Create("Frame", {
                Parent = subSection,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 0, 50)
            })

            local label = Utility:Create("TextLabel", {
                Parent = sliderFrame,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 0, 20),
                Text = text,
                TextColor3 = textColor,
                Font = Enum.Font.SourceSans,
                TextSize = 14
            })

            local sliderBar = Utility:Create("Frame", {
                Parent = sliderFrame,
                BackgroundColor3 = Color3.fromRGB(100, 100, 100),
                Size = UDim2.new(1, 0, 0, 5),
                Position = UDim2.new(0, 0, 0, 25)
            })
            Utility:Create("UICorner", {Parent = sliderBar, CornerRadius = UDim.new(0, 3)})

            local fill = Utility:Create("Frame", {
                Parent = sliderBar,
                BackgroundColor3 = Color3.fromRGB(0, 255, 0),
                Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
            })
            Utility:Create("UICorner", {Parent = fill, CornerRadius = UDim.new(0, 3)})

            local valueLabel = Utility:Create("TextLabel", {
                Parent = sliderFrame,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 0, 20),
                Position = UDim2.new(0, 0, 0, 30),
                Text = tostring(default),
                TextColor3 = textColor,
                Font = Enum.Font.SourceSans,
                TextSize = 14
            })

            local dragging = false
            sliderBar.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                end
            end)
            sliderBar.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                end
            end)
            game:GetService("UserInputService").InputChanged:Connect(function(input)
                if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    local relativeX = math.clamp((input.Position.X - sliderBar.AbsolutePosition.X) / sliderBar.AbsoluteSize.X, 0, 1)
                    local value = min + (max - min) * relativeX
                    value = math.round(value)
                    fill.Size = UDim2.new(relativeX, 0, 1, 0)
                    valueLabel.Text = tostring(value)
                    if callback then callback(value) end
                end
            end)
            updateSize()
            return elements
        end

        function elements:addDropdown(text, options, default, callback)
            local dropdownFrame = Utility:Create("Frame", {
                Parent = subSection,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 0, 30)
            })

            local label = Utility:Create("TextLabel", {
                Parent = dropdownFrame,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, -30, 1, 0),
                Text = text .. ": " .. (default or options[1]),
                TextColor3 = textColor,
                Font = Enum.Font.SourceSans,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            })

            local dropButton = Utility:Create("TextButton", {
                Parent = dropdownFrame,
                BackgroundColor3 = sectionColor,
                Size = UDim2.new(0, 30, 1, 0),
                Position = UDim2.new(1, -30, 0, 0),
                Text = "v",
                TextColor3 = textColor
            })
            Utility:Create("UICorner", {Parent = dropButton})

            local dropdownList = Utility:Create("Frame", {
                Parent = dropdownFrame,
                BackgroundColor3 = sectionColor,
                Size = UDim2.new(1, 0, 0, 0),
                Position = UDim2.new(0, 0, 1, 0),
                Visible = false,
                ClipsDescendants = true
            })
            Utility:Create("UICorner", {Parent = dropdownList})
            local listLayout = Utility:Create("UIListLayout", {Parent = dropdownList})

            for _, opt in ipairs(options) do
                local optButton = Utility:Create("TextButton", {
                    Parent = dropdownList,
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 30),
                    Text = opt,
                    TextColor3 = textColor
                })
                optButton.MouseButton1Click:Connect(function()
                    label.Text = text .. ": " .. opt
                    dropdownList.Visible = false
                    if callback then callback(opt) end
                end)
            end

            dropButton.MouseButton1Click:Connect(function()
                dropdownList.Visible = not dropdownList.Visible
                dropdownList.Size = UDim2.new(1, 0, 0, #options * 30)
            end)
            updateSize()
            return elements
        end

        -- addMultiDropdown similar to dropdown but with checkboxes, omitted for brevity, implement similarly

        function elements:addLabel(text)
            local label = Utility:Create("TextLabel", {
                Parent = subSection,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 0, 20),
                Text = text,
                TextColor3 = textColor,
                Font = Enum.Font.SourceSans,
                TextSize = 14
            })
            updateSize()
            return label
        end

        function elements:addKeybind(text, default, callback)
            local bindFrame = Utility:Create("Frame", {
                Parent = subSection,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 0, 30)
            })

            local label = Utility:Create("TextLabel", {
                Parent = bindFrame,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, -100, 1, 0),
                Text = text,
                TextColor3 = textColor,
                Font = Enum.Font.SourceSans,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            })

            local bindButton = Utility:Create("TextButton", {
                Parent = bindFrame,
                BackgroundColor3 = sectionColor,
                Size = UDim2.new(0, 100, 1, 0),
                Position = UDim2.new(1, -100, 0, 0),
                Text = default or "None",
                TextColor3 = textColor
            })
            Utility:Create("UICorner", {Parent = bindButton})

            local binding = false
            bindButton.MouseButton1Click:Connect(function()
                binding = true
                bindButton.Text = "Press key..."
            end)
            game:GetService("UserInputService").InputBegan:Connect(function(input)
                if binding and input.UserInputType == Enum.UserInputType.Keyboard then
                    local key = input.KeyCode.Name
                    bindButton.Text = key
                    binding = false
                    if callback then callback(key) end
                end
            end)
            updateSize()
            return elements
        end

        return elements
    end

    return sectionObj
end

-- Example usage (remove or comment out in actual script)
-- local section1 = UI:addSection("Section 1", 1234567890) -- decalId example
-- local sub1 = section1:addSubSection("SubSection 1")
-- sub1:addButton("Button", function() print("Clicked") end)
-- sub1:addToggle("Toggle", true, function(state) print(state) end)
-- sub1:addSlider("Slider", 0, 100, 50, function(value) print(value) end)
-- sub1:addDropdown("Dropdown", {"Opt1", "Opt2"}, "Opt1", function(opt) print(opt) end)
-- sub1:addLabel("Label")
-- sub1:addKeybind("Keybind", "E", function(key) print(key) end)

-- Return UI for external use
return UI
